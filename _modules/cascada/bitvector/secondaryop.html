<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cascada.bitvector.secondaryop &mdash; CASCADA 1.0.rc0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> CASCADA
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">CASCADA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../primitives_implemented.html">Primitives implemented</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cascada.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CASCADA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>cascada.bitvector.secondaryop</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cascada.bitvector.secondaryop</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Provide additional (secondary) bit-vector operators.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">math</span>

<span class="kn">from</span> <span class="nn">cascada.bitvector</span> <span class="kn">import</span> <span class="n">core</span>
<span class="kn">from</span> <span class="nn">cascada.bitvector</span> <span class="kn">import</span> <span class="n">operation</span>


<div class="viewcode-block" id="BvMaj"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.BvMaj">[docs]</a><span class="k">class</span> <span class="nc">BvMaj</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">SecondaryOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The bit-wise majority function.</span>

<span class="sd">    The bit-wise majority function ``BvMaj(x, y, z)``</span>
<span class="sd">    is defined for each bit ``i`` as the most common</span>
<span class="sd">    bit in ``[x[i], y[i], z[i]]``.</span>

<span class="sd">    Since `BvMaj` is a `SecondaryOperation`, by default it is fully evaluated</span>
<span class="sd">    (i.e., `Operation.eval` is used) when all the inputs are constants (see also</span>
<span class="sd">    `context.SecondaryOperationEvaluation`). On the other hand, `pre_eval`</span>
<span class="sd">    is always called in the evaluation (even with symbolic inputs).</span>

<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.core import Constant, Variable</span>
<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.secondaryop import BvMaj</span>
<span class="sd">        &gt;&gt;&gt; BvMaj(Constant(0b000, 3), Constant(0b001, 3), Constant(0b011, 3))</span>
<span class="sd">        0b001</span>
<span class="sd">        &gt;&gt;&gt; BvMaj(Variable(&quot;x&quot;, 4), Variable(&quot;y&quot;, 4), Variable(&quot;z&quot;, 4))</span>
<span class="sd">        BvMaj(x, y, z)</span>
<span class="sd">        &gt;&gt;&gt; BvMaj(Variable(&quot;x&quot;, 4), Variable(&quot;x&quot;, 4), Variable(&quot;z&quot;, 4))</span>
<span class="sd">        x</span>
<span class="sd">        &gt;&gt;&gt; BvMaj(Variable(&quot;x&quot;, 4), Variable(&quot;y&quot;, 4), Variable(&quot;z&quot;, 4)).doit()</span>
<span class="sd">        (x &amp; y) | (x &amp; z) | (y &amp; z)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">is_symmetric</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">is_simple</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="BvMaj.condition"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.BvMaj.condition">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">z</span><span class="o">.</span><span class="n">width</span></div>

<div class="viewcode-block" id="BvMaj.output_width"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.BvMaj.output_width">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">output_width</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span></div>

<div class="viewcode-block" id="BvMaj.pre_eval"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.BvMaj.pre_eval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">pre_eval</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">==</span> <span class="n">z</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="k">elif</span> <span class="n">y</span> <span class="o">==</span> <span class="n">z</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">y</span></div>

<div class="viewcode-block" id="BvMaj.eval"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.BvMaj.eval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">y</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">z</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">y</span> <span class="o">&amp;</span> <span class="n">z</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="BvIf"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.BvIf">[docs]</a><span class="k">class</span> <span class="nc">BvIf</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">SecondaryOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The bit-wise conditional (If) function.</span>

<span class="sd">    The bit-wise conditional function ``BvIf(x, y, z)``</span>
<span class="sd">    is defined for each bit ``i`` as ``y[i]`` if ``x[i]=1``</span>
<span class="sd">    otherwise ``z[i]``.</span>

<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.core import Constant, Variable</span>
<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.secondaryop import BvIf</span>
<span class="sd">        &gt;&gt;&gt; BvIf(Constant(0b01, 2), Constant(0b00, 2), Constant(0b11, 2))</span>
<span class="sd">        0b10</span>
<span class="sd">        &gt;&gt;&gt; BvIf(Variable(&quot;x&quot;, 4), Variable(&quot;y&quot;, 4), Variable(&quot;z&quot;, 4))</span>
<span class="sd">        BvIf(x, y, z)</span>
<span class="sd">        &gt;&gt;&gt; BvIf(0, Variable(&quot;y&quot;, 4), Variable(&quot;z&quot;, 4))</span>
<span class="sd">        z</span>
<span class="sd">        &gt;&gt;&gt; BvIf(Variable(&quot;x&quot;, 4), Variable(&quot;y&quot;, 4), Variable(&quot;z&quot;, 4)).doit()</span>
<span class="sd">        (x &amp; y) | (~x &amp; z)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">is_symmetric</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_simple</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="BvIf.condition"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.BvIf.condition">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">z</span><span class="o">.</span><span class="n">width</span></div>

<div class="viewcode-block" id="BvIf.output_width"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.BvIf.output_width">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">output_width</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span></div>

<div class="viewcode-block" id="BvIf.pre_eval"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.BvIf.pre_eval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">pre_eval</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">operation</span><span class="o">.</span><span class="n">BvNot</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">y</span>
        <span class="k">elif</span> <span class="n">x</span> <span class="o">==</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">z</span></div>

<div class="viewcode-block" id="BvIf.eval"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.BvIf.eval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">y</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="o">~</span><span class="n">x</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">z</span><span class="p">)</span></div></div>


<span class="k">def</span> <span class="nf">_repeat_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Repeat the pattern until obtain a bit-vector of given width.&quot;&quot;&quot;</span>
    <span class="k">assert</span> <span class="n">width</span> <span class="o">%</span> <span class="n">pattern</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">0</span>
    <span class="k">return</span> <span class="n">operation</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">width</span> <span class="o">//</span> <span class="n">pattern</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_pattern01</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Obtain the pattern 0...01...1 with given 0-width.&quot;&quot;&quot;</span>
    <span class="n">zeroes</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">operation</span><span class="o">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">zeroes</span><span class="p">,</span> <span class="o">~</span><span class="n">zeroes</span><span class="p">)</span>


<div class="viewcode-block" id="PopCount"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCount">[docs]</a><span class="k">class</span> <span class="nc">PopCount</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">SecondaryOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Count the number of 1&#39;s in the bit-vector.</span>

<span class="sd">    This operation is also known as the hamming weight of a bit-vector.</span>

<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.core import Constant, Variable</span>
<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.secondaryop import PopCount</span>
<span class="sd">        &gt;&gt;&gt; PopCount(Constant(0b1010, 4))</span>
<span class="sd">        0b010</span>
<span class="sd">        &gt;&gt;&gt; PopCount(Constant(0b101, 3))</span>
<span class="sd">        0b10</span>
<span class="sd">        &gt;&gt;&gt; PopCount(Variable(&quot;x&quot;, 4)).doit()</span>
<span class="sd">        (((x - ((x &gt;&gt; 0x1) &amp; 0x5)) &amp; 0x3) + (((x - ((x &gt;&gt; 0x1) &amp; 0x5)) &gt;&gt; 0x2) &amp; 0x3))[2:]</span>
<span class="sd">        &gt;&gt;&gt; PopCount(Variable(&quot;x&quot;, 3)).doit()</span>
<span class="sd">        (0b0 :: (x[0])) + (0b0 :: (x[1])) + (0b0 :: (x[2]))</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">is_symmetric</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="PopCount.output_width"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCount.output_width">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">output_width</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span></div>

<div class="viewcode-block" id="PopCount.eval"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCount.eval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">bv</span><span class="p">):</span>
        <span class="c1"># Source: Hacker&#39;s Delight</span>

        <span class="k">if</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">output_width</span><span class="p">(</span><span class="n">bv</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">sum</span><span class="p">([</span><span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">bv</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">w</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">)])</span>

        <span class="c1"># extend the bv until power of 2 length</span>
        <span class="n">original_width</span> <span class="o">=</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bv</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">width_log2</span> <span class="o">=</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">m_cts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width_log2</span><span class="p">):</span>
            <span class="n">m_cts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_repeat_pattern</span><span class="p">(</span><span class="n">_pattern01</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">),</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m_cts</span><span class="p">):</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bv</span><span class="p">[</span><span class="n">original_width</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m_cts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">bv</span> <span class="o">-</span> <span class="p">((</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>  <span class="c1"># generic case</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="p">(</span><span class="n">bv</span> <span class="o">+</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="n">m</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">bv</span> <span class="o">+</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">bv</span> <span class="o">+</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">bv</span><span class="p">[</span><span class="n">original_width</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span></div></div>


<div class="viewcode-block" id="Reverse"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.Reverse">[docs]</a><span class="k">class</span> <span class="nc">Reverse</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">SecondaryOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Reverse the bit-vector.</span>

<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.core import Constant, Variable</span>
<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.secondaryop import PopCount</span>
<span class="sd">        &gt;&gt;&gt; Reverse(Constant(0b1010, 4))</span>
<span class="sd">        0x5</span>
<span class="sd">        &gt;&gt;&gt; Reverse(Constant(0b001, 3))</span>
<span class="sd">        0b100</span>
<span class="sd">        &gt;&gt;&gt; Reverse(Variable(&quot;x&quot;, 4)).doit()  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        (((((x &amp; 0x5) &lt;&lt; 0x1) | ((x &gt;&gt; 0x1) &amp; 0x5)) &amp; 0x3) &lt;&lt; 0x2) |</span>
<span class="sd">        (((((x &amp; 0x5) &lt;&lt; 0x1) | ((x &gt;&gt; 0x1) &amp; 0x5)) &gt;&gt; 0x2) &amp; 0x3)</span>
<span class="sd">        &gt;&gt;&gt; Reverse(Variable(&quot;x&quot;, 3)).doit()</span>
<span class="sd">        (x[0]) :: (x[1]) :: (x[2])</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">is_symmetric</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="Reverse.output_width"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.Reverse.output_width">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">output_width</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span></div>

<div class="viewcode-block" id="Reverse.eval"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.Reverse.eval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">bv</span><span class="p">):</span>
        <span class="c1"># Source: Hacker&#39;s Delight</span>

        <span class="k">if</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bv</span>
        <span class="k">elif</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">operation</span><span class="o">.</span><span class="n">RotateLeft</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">operation</span><span class="o">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">bv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bv</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">bv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="n">original_width</span> <span class="o">=</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bv</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">width_log2</span> <span class="o">=</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">m_cts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width_log2</span><span class="p">):</span>
            <span class="n">m_cts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_repeat_pattern</span><span class="p">(</span><span class="n">_pattern01</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">),</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">m_cts</span><span class="p">)):</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="p">((</span><span class="n">bv</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">bv</span><span class="p">[:</span><span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">original_width</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">m_cts</span><span class="p">))[:</span><span class="mi">3</span><span class="p">]:</span>
            <span class="n">bv</span> <span class="o">=</span> <span class="p">((</span><span class="n">bv</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">|</span> \
                 <span class="p">((</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>  <span class="c1"># generic case</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_cts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">bv</span> <span class="o">=</span> <span class="p">((</span><span class="n">bv</span> <span class="o">&amp;</span> <span class="n">m_cts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m_cts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">m_cts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">rol</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">RotateLeft</span>
            <span class="n">ror</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">RotateRight</span>
            <span class="n">bv</span> <span class="o">=</span> <span class="n">ror</span><span class="p">(</span><span class="n">bv</span> <span class="o">&amp;</span> <span class="n">m_cts</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">rol</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">m_cts</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">bv</span><span class="p">[:</span><span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">original_width</span><span class="p">]</span></div></div>


<div class="viewcode-block" id="PopCountSum2"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCountSum2">[docs]</a><span class="k">class</span> <span class="nc">PopCountSum2</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">SecondaryOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Count the number of 1&#39;s of two bit-vectors.</span>

<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.core import Constant, Variable</span>
<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.secondaryop import PopCountSum2</span>
<span class="sd">        &gt;&gt;&gt; PopCountSum2(Constant(0b000, 3), Constant(0b001, 3))</span>
<span class="sd">        0b001</span>
<span class="sd">        &gt;&gt;&gt; PopCountSum2(~Constant(0, 15), ~Constant(0, 15))</span>
<span class="sd">        0b11110</span>
<span class="sd">        &gt;&gt;&gt; PopCountSum2(Variable(&quot;x&quot;, 4), Variable(&quot;y&quot;, 4)).doit()  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        ((x - ((x &gt;&gt; 0x1) &amp; 0x5)) &amp; 0x3) + (((x - ((x &gt;&gt; 0x1) &amp; 0x5)) &gt;&gt; 0x2) &amp; 0x3) +</span>
<span class="sd">        ((y - ((y &gt;&gt; 0x1) &amp; 0x5)) &amp; 0x3) + (((y - ((y &gt;&gt; 0x1) &amp; 0x5)) &gt;&gt; 0x2) &amp; 0x3)</span>
<span class="sd">        &gt;&gt;&gt; PopCountSum2(Variable(&quot;x&quot;, 3), Variable(&quot;y&quot;, 3)).doit()  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        (0b0 :: ((0b0 :: (x[0])) + (0b0 :: (x[1])) + (0b0 :: (x[2])))) +</span>
<span class="sd">        (0b0 :: ((0b0 :: (y[0])) + (0b0 :: (y[1])) + (0b0 :: (y[2]))))</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">is_symmetric</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">is_simple</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="PopCountSum2.condition"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCountSum2.condition">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">width</span></div>

<div class="viewcode-block" id="PopCountSum2.output_width"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCountSum2.output_width">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">output_width</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PopCount</span><span class="o">.</span><span class="n">output_width</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="n">y</span><span class="o">.</span><span class="n">width</span><span class="p">)</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span></div>

<div class="viewcode-block" id="PopCountSum2.eval"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCountSum2.eval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># Source: Hacker&#39;s Delight</span>

        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># the HW of a 1-bit/2-bit vector requires 1-bit/2-bit (HW(0b1)=0b1, HW(0b11)=0b10)</span>
            <span class="c1"># thus, the sum of two HW of these sizes require an extra bit</span>
            <span class="c1"># the HW of a 3-bit vector requires 2-bit (Hw(0b111)=0b11)</span>
            <span class="c1"># and the sum of two HW of 3-bit also require an extra bit</span>
            <span class="k">return</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">PopCount</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">PopCount</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">output_width</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">PopCount</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">PopCount</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>

        <span class="n">orig_x</span><span class="p">,</span> <span class="n">orig_y</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">width</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">width_log2</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">m_cts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width_log2</span><span class="p">):</span>
            <span class="n">m_cts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_repeat_pattern</span><span class="p">(</span><span class="n">_pattern01</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>

        <span class="n">bv</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m_cts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="p">((</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>  <span class="c1"># generic case</span>
                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">bv</span> <span class="o">+</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">bv</span> <span class="o">+</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">bv</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">output_width</span><span class="p">(</span><span class="n">orig_x</span><span class="p">,</span> <span class="n">orig_y</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span></div></div>


<div class="viewcode-block" id="PopCountSum3"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCountSum3">[docs]</a><span class="k">class</span> <span class="nc">PopCountSum3</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">SecondaryOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Count the number of 1&#39;s of three bit-vectors.</span>

<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.core import Constant, Variable</span>
<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.secondaryop import PopCountSum3</span>
<span class="sd">        &gt;&gt;&gt; PopCountSum3(Constant(0b000, 3), Constant(0b001, 3), Constant(0b011, 3))</span>
<span class="sd">        0x3</span>
<span class="sd">        &gt;&gt;&gt; PopCountSum3(Variable(&quot;x&quot;, 4), Variable(&quot;y&quot;, 4), Variable(&quot;z&quot;, 4)).doit()  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        ((x - ((x &gt;&gt; 0x1) &amp; 0x5)) &amp; 0x3) + (((x - ((x &gt;&gt; 0x1) &amp; 0x5)) &gt;&gt; 0x2) &amp; 0x3) +</span>
<span class="sd">        ((y - ((y &gt;&gt; 0x1) &amp; 0x5)) &amp; 0x3) + (((y - ((y &gt;&gt; 0x1) &amp; 0x5)) &gt;&gt; 0x2) &amp; 0x3) +</span>
<span class="sd">        ((z - ((z &gt;&gt; 0x1) &amp; 0x5)) &amp; 0x3) + (((z - ((z &gt;&gt; 0x1) &amp; 0x5)) &gt;&gt; 0x2) &amp; 0x3)</span>
<span class="sd">        &gt;&gt;&gt; PopCountSum3(Variable(&quot;x&quot;, 3), Variable(&quot;y&quot;, 3), Constant(0, 3)).doit()  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        (0b00 :: ((0b0 :: (x[0])) + (0b0 :: (x[1])) + (0b0 :: (x[2])))) +</span>
<span class="sd">        (0b00 :: ((0b0 :: (y[0])) + (0b0 :: (y[1])) + (0b0 :: (y[2]))))</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">is_symmetric</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">is_simple</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="PopCountSum3.condition"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCountSum3.condition">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">z</span><span class="o">.</span><span class="n">width</span></div>

<div class="viewcode-block" id="PopCountSum3.output_width"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCountSum3.output_width">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">output_width</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">return</span> <span class="n">PopCount</span><span class="o">.</span><span class="n">output_width</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="n">y</span><span class="o">.</span><span class="n">width</span> <span class="o">+</span> <span class="n">z</span><span class="o">.</span><span class="n">width</span><span class="p">)</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span></div>

<div class="viewcode-block" id="PopCountSum3.eval"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCountSum3.eval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">):</span>
        <span class="c1"># Source: Hacker&#39;s Delight</span>

        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="c1"># the HW of a 1-bit/2-bit vector requires 1-bit/2-bit (HW(0b1)=0b1, HW(0b11)=0b10)</span>
            <span class="c1"># thus, the sum of three HW of these sizes require an extra bit (3*0b1=0b11, 3*0b10=0b110)</span>
            <span class="c1"># the HW of a 3-bit vector requires 2-bit (Hw(0b111)=0b11)</span>
            <span class="c1"># but the sum of three HW of 3-bit require two extra bit (3*0b11 = 0b1001)</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">PopCount</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">offset</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">PopCount</span><span class="p">(</span><span class="n">y</span><span class="p">),</span> <span class="n">offset</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">PopCount</span><span class="p">(</span><span class="n">z</span><span class="p">),</span> <span class="n">offset</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span>
        <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">:</span>
            <span class="n">width</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">output_width</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">PopCount</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">PopCount</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">PopCount</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="n">width</span> <span class="o">-</span> <span class="n">z</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span>

        <span class="n">orig_x</span><span class="p">,</span> <span class="n">orig_y</span><span class="p">,</span> <span class="n">orig_z</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">width</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">width</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">z</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">width_log2</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">m_cts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width_log2</span><span class="p">):</span>
            <span class="n">m_cts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_repeat_pattern</span><span class="p">(</span><span class="n">_pattern01</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>

        <span class="n">bv</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m_cts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="p">((</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="p">((</span><span class="n">z</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>  <span class="c1"># generic case</span>
                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">z</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span> <span class="n">z</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">bv</span> <span class="o">+</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">bv</span> <span class="o">+</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">bv</span><span class="p">[</span><span class="bp">cls</span><span class="o">.</span><span class="n">output_width</span><span class="p">(</span><span class="n">orig_x</span><span class="p">,</span> <span class="n">orig_y</span><span class="p">,</span> <span class="n">orig_z</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span></div></div>


<div class="viewcode-block" id="PopCountDiff"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCountDiff">[docs]</a><span class="k">class</span> <span class="nc">PopCountDiff</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">SecondaryOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the difference of the hamming weight of two words.</span>

<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.core import Constant, Variable</span>
<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.secondaryop import PopCountDiff</span>
<span class="sd">        &gt;&gt;&gt; PopCountDiff(Constant(0b011, 3), Constant(0b100, 3))</span>
<span class="sd">        0b01</span>
<span class="sd">        &gt;&gt;&gt; PopCountDiff(Variable(&quot;x&quot;, 4), Variable(&quot;y&quot;, 4)).doit()  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        ((((x - ((x &gt;&gt; 0x1) &amp; 0x5)) &amp; 0x3) + (((x - ((x &gt;&gt; 0x1) &amp; 0x5)) &gt;&gt; 0x2) &amp; 0x3) +</span>
<span class="sd">        ((~y - ((~y &gt;&gt; 0x1) &amp; 0x5)) &amp; 0x3) + (((~y - ((~y &gt;&gt; 0x1) &amp; 0x5)) &gt;&gt; 0x2) &amp; 0x3)) - 0x4)[2:]</span>
<span class="sd">        &gt;&gt;&gt; PopCountDiff(Variable(&quot;x&quot;, 3), Variable(&quot;y&quot;, 3)).doit()  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">        ((0b0 :: (x[0])) + (0b0 :: (x[1])) + (0b0 :: (x[2]))) -</span>
<span class="sd">        ((0b0 :: (y[0])) + (0b0 :: (y[1])) + (0b0 :: (y[2])))</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">is_symmetric</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">is_simple</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="PopCountDiff.condition"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCountDiff.condition">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">y</span><span class="o">.</span><span class="n">width</span></div>

<div class="viewcode-block" id="PopCountDiff.output_width"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCountDiff.output_width">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">output_width</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span></div>

<div class="viewcode-block" id="PopCountDiff.eval"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.PopCountDiff.eval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="c1"># Source: Hacker&#39;s Delight</span>

        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PopCount</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">PopCount</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">PopCount</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">PopCount</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="n">orig_x</span><span class="p">,</span> <span class="n">orig_y</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">width</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">width_log2</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="n">m_cts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width_log2</span><span class="p">):</span>
            <span class="n">m_cts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_repeat_pattern</span><span class="p">(</span><span class="n">_pattern01</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>

        <span class="n">bv</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">m_cts</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="p">(((</span><span class="o">~</span><span class="n">y</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>  <span class="c1"># generic case</span>
                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">y</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">bv</span> <span class="o">+</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">bv</span> <span class="o">=</span> <span class="n">bv</span> <span class="o">+</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">bv</span> <span class="o">-</span> <span class="n">y</span><span class="o">.</span><span class="n">width</span><span class="p">)[</span><span class="bp">cls</span><span class="o">.</span><span class="n">output_width</span><span class="p">(</span><span class="n">orig_x</span><span class="p">,</span> <span class="n">orig_y</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span></div></div>


<div class="viewcode-block" id="LeadingZeros"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.LeadingZeros">[docs]</a><span class="k">class</span> <span class="nc">LeadingZeros</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">SecondaryOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return a bit-vector with the leading zeros set to one and the rest to zero.</span>

<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.core import Constant, Variable</span>
<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.secondaryop import PopCount</span>
<span class="sd">        &gt;&gt;&gt; LeadingZeros(Constant(0b11111, 5))</span>
<span class="sd">        0b00000</span>
<span class="sd">        &gt;&gt;&gt; LeadingZeros(Constant(0b001, 3))</span>
<span class="sd">        0b110</span>
<span class="sd">        &gt;&gt;&gt; LeadingZeros(Variable(&quot;x&quot;, 4)).doit()</span>
<span class="sd">        ~(x | (x &gt;&gt; 0x1) | ((x | (x &gt;&gt; 0x1)) &gt;&gt; 0x2))</span>
<span class="sd">        &gt;&gt;&gt; LeadingZeros(Variable(&quot;x&quot;, 3)).doit()</span>
<span class="sd">        ~(((0b0 :: x) | ((0b0 :: x) &gt;&gt; 0x1) | (((0b0 :: x) | ((0b0 :: x) &gt;&gt; 0x1)) &gt;&gt; 0x2))[2:])</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">arity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">is_symmetric</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="LeadingZeros.output_width"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.LeadingZeros.output_width">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">output_width</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span></div>

<div class="viewcode-block" id="LeadingZeros.eval"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.LeadingZeros.eval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">bv</span><span class="p">):</span>
        <span class="c1"># Source: Hacker&#39;s Delight</span>

        <span class="k">if</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">~</span><span class="n">bv</span>

        <span class="n">original_width</span> <span class="o">=</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bv</span><span class="o">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">bv</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">bv</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">width_log2</span> <span class="o">=</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="o">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width_log2</span><span class="p">):</span>
            <span class="n">bv</span> <span class="o">=</span> <span class="n">bv</span> <span class="o">|</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&gt;&gt;</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">i</span><span class="p">,</span> <span class="n">bv</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
        <span class="k">return</span> <span class="o">~</span><span class="n">bv</span><span class="p">[</span><span class="n">original_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span></div></div>


<div class="viewcode-block" id="LutOperation"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.LutOperation">[docs]</a><span class="k">class</span> <span class="nc">LutOperation</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">SecondaryOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for LUT-based operations.</span>

<span class="sd">    Given a LUT (look-up table) ``T`` with `Constant` elements,</span>
<span class="sd">    the (bit-vector) LUT-based operation ``T(x)``</span>
<span class="sd">    (with bit-vector input ``x``) returns the bit-vector of ``T``</span>
<span class="sd">    in the position given by the integer value of ``x``.</span>

<span class="sd">    Since `LutOperation` is a `SecondaryOperation`, it is only evaluated</span>
<span class="sd">    by default when the input is a constant value</span>
<span class="sd">    (see also `context.SecondaryOperationEvaluation`).</span>

<span class="sd">    This class is not meant to be instantiated but to provide a base</span>
<span class="sd">    class for LUT-based operations. To define a LUT-based operation,</span>
<span class="sd">    subclass `LutOperation` and provide the class attribute `lut`.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        lut: the table that defines the LUT-based operation given as a</span>
<span class="sd">            list of `Constant` objects.</span>

<span class="sd">    ::</span>

<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.core import Constant, Variable</span>
<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.secondaryop import LutOperation</span>
<span class="sd">        &gt;&gt;&gt; class MyInvertibleLut(LutOperation): lut = [Constant(i, 2) for i in reversed(range(2**2))]</span>
<span class="sd">        &gt;&gt;&gt; MyInvertibleLut(Constant(0, 2))</span>
<span class="sd">        0b11</span>
<span class="sd">        &gt;&gt;&gt; MyInvertibleLut(Variable(&quot;a&quot;, 2)).doit()</span>
<span class="sd">        Ite(a == 0b00, 0b11, Ite(a == 0b01, 0b10, Ite(a == 0b10, 0b01, 0b00)))</span>
<span class="sd">        &gt;&gt;&gt; class MyNonInvLut(LutOperation): lut = [Constant(0, 8), ~Constant(0, 8)]</span>
<span class="sd">        &gt;&gt;&gt; MyNonInvLut(Variable(&quot;a&quot;, 1)).doit()</span>
<span class="sd">        Ite(a == 0b0, 0x00, 0xff)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">is_symmetric</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_input_width</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">_iw</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">lut</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">_iw</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">_iw</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_iw</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_output_width</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">_ow</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">lut</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">width</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">elem</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">_ow</span> <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">lut</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_ow</span>

<div class="viewcode-block" id="LutOperation.condition"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.LutOperation.condition">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_input_width</span></div>

<div class="viewcode-block" id="LutOperation.output_width"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.LutOperation.output_width">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">output_width</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_output_width</span></div>

<div class="viewcode-block" id="LutOperation.eval"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.LutOperation.eval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_input_width</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2"> only supports </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">_input_width</span><span class="si">}</span><span class="s2">-bit inputs&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">lut</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">expr</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">lut</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># backward iteration</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">lut</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">Ite</span><span class="p">(</span>
                    <span class="n">operation</span><span class="o">.</span><span class="n">BvComp</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span><span class="p">)),</span>
                    <span class="bp">cls</span><span class="o">.</span><span class="n">lut</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">expr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">expr</span></div></div>


<div class="viewcode-block" id="MatrixOperation"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.MatrixOperation">[docs]</a><span class="k">class</span> <span class="nc">MatrixOperation</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">SecondaryOperation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for matrix-vector products.</span>

<span class="sd">    Given a binary matrix as a 2-dimensional list ``M`` with 1-bit `Constant`</span>
<span class="sd">    elements (``M[i][j]`` is the j-th column element in the i-th row),</span>
<span class="sd">    the (bit-vector) matrix-vector product ``M(x)``</span>
<span class="sd">    (with bit-vector input ``x``) returns the bit-vector of ``y``</span>
<span class="sd">    such the i-th bit of ``y`` is given by</span>
<span class="sd">    ``y[i] = (M[i][0] &amp; x[0]) ^ (M[i][1] &amp; x[1]) ^ ... ^ (M[i][n-1] &amp; x[n-1])``</span>
<span class="sd">    where ``n`` is the number of columns and the width of ``x``.</span>

<span class="sd">    Since `MatrixOperation` is a `SecondaryOperation`, it is only evaluated</span>
<span class="sd">    by default when the input is a constant value</span>
<span class="sd">    (see also `context.SecondaryOperationEvaluation`).</span>

<span class="sd">    This class is not meant to be instantiated but to provide a base</span>
<span class="sd">    class for matrix-vector products. To define a matrix-vector product,</span>
<span class="sd">    subclass `MatrixOperation` and provide the class attribute `matrix`.</span>

<span class="sd">    .. note::</span>
<span class="sd">        By default, a `MatrixOperation` subclass takes 1 input operand ``x``,</span>
<span class="sd">        but `arity` can be changed to support multiple operands.</span>
<span class="sd">        In this case, the list of inputs ``(x_1, ..., x_n)`` are concatenated</span>
<span class="sd">        into ``x`` as ``x = x_n :: ... :: x_1``</span>
<span class="sd">        (``x_1`` denoting the least-significant part and ``x_n``</span>
<span class="sd">        denoting the most-significant part).</span>

<span class="sd">        In other words, a `MatrixOperation` subclass with ``arity == [n, 0]``</span>
<span class="sd">        and input ``(x_1, ..., x_n)`` computes ``M(x_n :: ... :: x_1)``.</span>


<span class="sd">    Alternatively, binary matrices can be implemented as a</span>
<span class="sd">    sequence of `BvXor` operations</span>
<span class="sd">    (e.g., https://eprint.iacr.org/2021/1400).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        matrix: the binary matrix as a 2D list of 1-bit `Constant` objects.</span>

<span class="sd">    ::</span>

<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.core import Constant, Variable</span>
<span class="sd">        &gt;&gt;&gt; from cascada.bitvector.secondaryop import MatrixOperation</span>
<span class="sd">        &gt;&gt;&gt; matrix = [[0, 1], [1, 0]]  # reverse</span>
<span class="sd">        &gt;&gt;&gt; matrix = [[core.Constant(x, 1) for x in row] for row in matrix]</span>
<span class="sd">        &gt;&gt;&gt; class MySquareMatrix(MatrixOperation): matrix = matrix</span>
<span class="sd">        &gt;&gt;&gt; MySquareMatrix(Constant(0, 2))</span>
<span class="sd">        0b00</span>
<span class="sd">        &gt;&gt;&gt; MySquareMatrix(Variable(&quot;a&quot;, 2)).doit()</span>
<span class="sd">        (a[0]) :: (a[1])</span>
<span class="sd">        &gt;&gt;&gt; matrix = [[1, 0], [0, 1], [1, 0], [0, 1]]  # 2 bit to 4 bit</span>
<span class="sd">        &gt;&gt;&gt; matrix = [[core.Constant(x, 1) for x in row] for row in matrix]</span>
<span class="sd">        &gt;&gt;&gt; class MyNonSqMatrix(MatrixOperation): arity, matrix = [2, 0], matrix</span>
<span class="sd">        &gt;&gt;&gt; MyNonSqMatrix(Variable(&quot;a0&quot;, 1), Variable(&quot;a1&quot;, 1)).doit()</span>
<span class="sd">        a1 :: a0 :: a1 :: a0</span>


<span class="sd">    .. Implementation details:</span>

<span class="sd">        Other matrix-2-XOR papers:</span>
<span class="sd">        https://doi.org/10.1007/978-3-030-75539-3_25</span>
<span class="sd">        https://tches.iacr.org/index.php/TCHES/article/view/8398</span>
<span class="sd">        https://tosc.iacr.org/index.php/ToSC/article/view/8671</span>
<span class="sd">        https://tosc.iacr.org/index.php/ToSC/article/view/813</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">arity</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">is_symmetric</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_input_width</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="n">num_columns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">==</span> <span class="n">num_columns</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">num_columns</span>

    <span class="nd">@classmethod</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_output_width</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>

<div class="viewcode-block" id="MatrixOperation.condition"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.MatrixOperation.condition">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_input_width</span></div>

<div class="viewcode-block" id="MatrixOperation.output_width"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.MatrixOperation.output_width">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">output_width</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_output_width</span></div>

<div class="viewcode-block" id="MatrixOperation.eval"><a class="viewcode-back" href="../../../cascada.bitvector.secondaryop.html#cascada.bitvector.secondaryop.MatrixOperation.eval">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">eval</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">Concat</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">args</span><span class="p">))</span>  <span class="c1"># args[0] LS part</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">width</span> <span class="o">!=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_input_width</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2"> only supports inputs with total width </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">_input_width</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">output_bv</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">matrix</span><span class="p">))]</span>
        <span class="n">num_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">matrix</span><span class="p">)</span>
        <span class="n">num_columns</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>  <span class="c1"># == cls._input_width</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_rows</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_columns</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">output_bv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">output_bv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">output_bv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">matrix</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">Concat</span><span class="p">,</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">output_bv</span><span class="p">))</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Adrián Ranea.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>