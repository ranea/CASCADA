<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>cascada.abstractproperty.characteristic &mdash; CASCADA 1.0.rc0 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> CASCADA
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">CASCADA</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../primitives_implemented.html">Primitives implemented</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cascada.html">API reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">CASCADA</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>cascada.abstractproperty.characteristic</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for cascada.abstractproperty.characteristic</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Manage non-symbolic characteristics w.r.t an abstract property.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">from</span> <span class="nn">cascada.bitvector</span> <span class="kn">import</span> <span class="n">core</span>
<span class="kn">from</span> <span class="nn">cascada.bitvector</span> <span class="kn">import</span> <span class="n">context</span>
<span class="kn">from</span> <span class="nn">cascada.bitvector</span> <span class="kn">import</span> <span class="n">ssa</span> <span class="k">as</span> <span class="n">cascada_ssa</span>
<span class="kn">from</span> <span class="nn">cascada.bitvector</span> <span class="kn">import</span> <span class="n">operation</span>
<span class="kn">from</span> <span class="nn">cascada.abstractproperty</span> <span class="kn">import</span> <span class="nb">property</span>
<span class="kn">from</span> <span class="nn">cascada.abstractproperty</span> <span class="kn">import</span> <span class="n">chmodel</span> <span class="k">as</span> <span class="n">cascada_chmodel</span>
<span class="kn">from</span> <span class="nn">cascada.abstractproperty</span> <span class="kn">import</span> <span class="n">opmodel</span> <span class="k">as</span> <span class="n">cascada_opmodel</span>


<span class="nb">zip</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="nb">zip</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<div class="viewcode-block" id="EmpiricalWeightData"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.EmpiricalWeightData">[docs]</a><span class="k">class</span> <span class="nc">EmpiricalWeightData</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent the auxiliary data of `empirical_ch_weight`.</span>

<span class="sd">    This class stores the auxiliary data (the auxiliary empirical weights</span>
<span class="sd">    and the input parameters) of characteristic empirical weights</span>
<span class="sd">    computed through the method `Characteristic.compute_empirical_ch_weight`.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        weight_avg_aux_prs: the negative binary logarithm (weight)</span>
<span class="sd">            of the average of the underlying probabilities of the</span>
<span class="sd">            auxiliary empirical weights</span>
<span class="sd">        num_aux_weights: the total number of auxiliary weights computed</span>
<span class="sd">            (including weights with value `math.inf`)</span>
<span class="sd">        num_inf_aux_weights: the number of auxiliary weights with value `math.inf`</span>
<span class="sd">        num_input_samples: the number of inputs sampled</span>
<span class="sd">        num_external_samples: the number of external samples used</span>
<span class="sd">            (equal to the number of auxiliary weights if there are two or more)</span>
<span class="sd">        seed: the seed used to sample bit-vectors</span>
<span class="sd">        C_code: whether the on-the-fly C implementations was used</span>
<span class="sd">        aux_weights: the list of auxiliary empirical weights</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">aux_weights</span><span class="p">,</span> <span class="n">num_input_samples</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">C_code</span><span class="p">,</span> <span class="n">num_external_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux_weights</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weight_avg_aux_prs</span> <span class="o">=</span> <span class="n">aux_weights</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># self.weight_avg_aux_prs is dependent of the order of aux_weights</span>
            <span class="n">aux_weights</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">aux_weights</span><span class="p">)</span>

            <span class="n">zero</span><span class="p">,</span> <span class="n">two</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">aux_prs</span> <span class="o">=</span> <span class="p">[</span><span class="n">zero</span> <span class="k">if</span> <span class="n">w</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span> <span class="k">else</span> <span class="n">two</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">w</span><span class="p">)</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">aux_weights</span><span class="p">]</span>

            <span class="n">avg_aux_prs</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">aux_prs</span><span class="p">)</span> <span class="o">/</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">aux_prs</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">avg_aux_prs</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weight_avg_aux_prs</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">weight_avg_aux_prs</span> <span class="o">=</span> <span class="o">-</span> <span class="n">cascada_opmodel</span><span class="o">.</span><span class="n">log2_decimal</span><span class="p">(</span><span class="n">avg_aux_prs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_aux_weights</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux_weights</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_inf_aux_weights</span> <span class="o">=</span> <span class="n">aux_weights</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_input_samples</span> <span class="o">=</span> <span class="n">num_input_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_external_samples</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">num_external_samples</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">num_external_samples</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_aux_weights</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_external_samples</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">C_code</span> <span class="o">=</span> <span class="n">C_code</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_avg_aux_prs</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">w</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">aux_weights</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aux_weights</span> <span class="o">=</span> <span class="n">aux_weights</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">key_lambda</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span> <span class="k">if</span> <span class="n">x</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span> <span class="k">else</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">weight_avg_aux_prs</span><span class="p">)</span><span class="o">.</span><span class="n">copy_abs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aux_weights</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">aux_weights</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">key_lambda</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(weight_avg_aux_prs=</span><span class="si">{}</span><span class="s2">, num_aux_weights=</span><span class="si">{}</span><span class="s2">, num_inf_aux_weights=</span><span class="si">{}</span><span class="s2">, &quot;</span> \
               <span class="s2">&quot;num_input_samples=</span><span class="si">{}</span><span class="s2">, seed=</span><span class="si">{}</span><span class="s2">, C_code=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">weight_avg_aux_prs</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_aux_weights</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_inf_aux_weights</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_input_samples</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C_code</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="fm">__repr__</span> <span class="o">=</span> <span class="fm">__str__</span>

<div class="viewcode-block" id="EmpiricalWeightData.vrepr"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.EmpiricalWeightData.vrepr">[docs]</a>    <span class="k">def</span> <span class="nf">vrepr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an executable string representation.</span>

<span class="sd">        This method returns a string so that ``eval(self.vrepr())``</span>
<span class="sd">        returns a new `EmpiricalWeightData` object with the same content.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(num_input_samples=</span><span class="si">{}{}</span><span class="s2">, seed=</span><span class="si">{}</span><span class="s2">, C_code=</span><span class="si">{}</span><span class="s2">, aux_weights=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_input_samples</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_external_samples</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, num_external_samples=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">num_external_samples</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">C_code</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">aux_weights</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="Characteristic"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.Characteristic">[docs]</a><span class="k">class</span> <span class="nc">Characteristic</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent characteristics over bit-vector functions w.r.t some property.</span>

<span class="sd">    Given a `BvFunction` :math:`f` and its `SSA` decomposition into a list of</span>
<span class="sd">    *simple* assignments :math:`x_{i+1} \leftarrow f_i(x_i)`,</span>
<span class="sd">    a characteristic is a trail of properties</span>
<span class="sd">    :math:`(\Delta_{x_0} \mapsto \Delta_{x_1} \mapsto \dots \mapsto \Delta_{x_r})`</span>
<span class="sd">    containing the input and output `Property` pair</span>
<span class="sd">    :math:`(\Delta_{x_{i}}, \Delta_{x_{i+1}})` of each</span>
<span class="sd">    assignment :math:`x_{i+1} \leftarrow f_i(x_i)`,</span>
<span class="sd">    where :math:`f_i` is a bit-vector `Operation`.</span>
<span class="sd">    The initial property :math:`\Delta_{x_0}` is called the input property</span>
<span class="sd">    of the characteristic, and the last property :math:`\Delta_{x_r}`</span>
<span class="sd">    is called the output property of the characteristic.</span>

<span class="sd">    If a `BvFunction` :math:`f` contains external variables,</span>
<span class="sd">    recall the external variables appear in the `SSA` as input operands in some</span>
<span class="sd">    assignments. Thus, the properties associated to the external variables</span>
<span class="sd">    appear in the characteristic trail as input properties of those</span>
<span class="sd">    assignments.</span>

<span class="sd">    .. note::</span>

<span class="sd">        For example, given the function :math:`f(x) = (x \oplus 1) \\boxplus z`</span>
<span class="sd">        with external variable :math:`z`, a characteristic over :math:`f` is</span>
<span class="sd">        a trail of properties given by 2 property pairs:</span>

<span class="sd">        - The first property pair :math:`(\Delta_x, \Delta_{x&#39;})`</span>
<span class="sd">          is over the assignment :math:`x&#39; \leftarrow f_0(x) = x \oplus 1`.</span>
<span class="sd">        - The second property pair :math:`((\Delta_{x&#39;}, \Delta_z), \Delta_{x&#39;&#39;})``</span>
<span class="sd">          is over the assignment :math:`x&#39;&#39; \leftarrow f_1(x&#39;, z) = x&#39; \\boxplus z`.</span>

<span class="sd">    The propagation probability of a characteristic,</span>
<span class="sd">    or simply the characteristic probability, is the product</span>
<span class="sd">    of the propagation probabilities of the `Property` pairs</span>
<span class="sd">    :math:`(\Delta_{x_{i}} \mapsto \Delta_{x_{i+1}})` over :math:`f_i`.</span>

<span class="sd">    The propagation weight of a characteristic is the negative binary</span>
<span class="sd">    logarithm of the characteristic probability, that is, the sum</span>
<span class="sd">    of the propagation weights of the `Property` pairs</span>
<span class="sd">    :math:`(\Delta_{x_{i}} \mapsto \Delta_{x_{i+1}})`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        For a function :math:`f(x) = g(x, x)` with duplicated input :math:`x`,</span>
<span class="sd">        if the property model of :math:`f` is not implemented but the model of</span>
<span class="sd">        :math:`g` is, then the property model of :math:`f` is approximated</span>
<span class="sd">        with the model of :math:`g`.</span>

<span class="sd">        For example, the `XorDiff` model of the unary operation</span>
<span class="sd">        :math:`f(x) = x \\boxplus x` is approximated</span>
<span class="sd">        by `XorModelBvAdd` with the same difference for the first and</span>
<span class="sd">        second operands.</span>

<span class="sd">    The characteristic probability is an approximation of the</span>
<span class="sd">    propagation probability of the property pair</span>
<span class="sd">    :math:`(\Delta_{x_0}, \Delta_{x_r})` over :math:`f`, but the accuracy</span>
<span class="sd">    of this approximation varies depending on the `Property` type,</span>
<span class="sd">    the function :math:`f` and the `SSA` decomposition of :math:`f`.</span>
<span class="sd">    For some properties such as  `Difference` and `LinearMask`,</span>
<span class="sd">    if :math:`f` has external variables then the characteristic probability</span>
<span class="sd">    approximates the propagation probability of :math:`(\Delta_{x_0}, \Delta_{x_r})`</span>
<span class="sd">    averaged over the set of all values of the external variables.</span>

<span class="sd">    A `Characteristic` is defined for a `abstractproperty.chmodel.ChModel`</span>
<span class="sd">    (providing the type of `Property`, the `BvFunction` :math:`f`,</span>
<span class="sd">    the `SSA` decomposition, and the (symbolic) `Property` propagations over</span>
<span class="sd">    the non-trivial assignments as `abstractproperty.opmodel.OpModel` objects).</span>

<span class="sd">    .. note::</span>

<span class="sd">        A `Characteristic` object represents an instance of characteristic</span>
<span class="sd">        (where all the properties and weights are constant values),</span>
<span class="sd">        whereas a `abstractproperty.chmodel.ChModel` object represents</span>
<span class="sd">        the (symbolic) model of a characteristic.</span>

<span class="sd">    A `Characteristic` also requires the values of the properties</span>
<span class="sd">    :math:`\Delta_{x_i}` in the trail. The property values can be given</span>
<span class="sd">    as `Constant` objects or `Property` of `Constant` objects.</span>

<span class="sd">    .. note::</span>

<span class="sd">        To initialize a `Characteristic`, all the constant values</span>
<span class="sd">        of the input, output, external and assignment-output properties</span>
<span class="sd">        must be given, even for properties not affecting the trail.</span>
<span class="sd">        These free symbolic properties can be given in the ``free_props``</span>
<span class="sd">        list to denote that their value does not affect the characteristic.</span>

<span class="sd">        If the underlying bit-vector function does not have external variables,</span>
<span class="sd">        or the attribute ``external_var2prop`` of the underlying characteristic</span>
<span class="sd">        model maps all external variables to constant `Property` objects,</span>
<span class="sd">        then the initialization argument ``external_props`` can be omitted.</span>

<span class="sd">    If the bit-vector function :math:`f` of the given</span>
<span class="sd">    `abstractproperty.chmodel.ChModel` is a</span>
<span class="sd">    `RoundBasedFunction` including `add_round_outputs` calls in its ``eval``,</span>
<span class="sd">    then the characteristic over each round can be obtaining by combining</span>
<span class="sd">    `split` and `get_round_separators`.</span>

<span class="sd">    To initialize an invalid `Characteristic` (with zero characteristic</span>
<span class="sd">    probability), the initialization argument ``is_valid=False``</span>
<span class="sd">    must be provided (by default, ``is_valid=True``).</span>

<span class="sd">    This class is not meant to be instantiated but to provide a base</span>
<span class="sd">    class for creating characteristic w.r.t some property,</span>
<span class="sd">    (see `differential.characteristic.Characteristic`,</span>
<span class="sd">    `linear.characteristic.Characteristic`</span>
<span class="sd">    or `algebraic.characteristic.Characteristic` for some examples).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        ch_model: the underlying `abstractproperty.chmodel.ChModel`.</span>
<span class="sd">        ch_weight: the decimal weight of the characteristic computed</span>
<span class="sd">            as the sum of `assignment_weights`.</span>
<span class="sd">        assignment_weights: the decimal weight of the `Property`</span>
<span class="sd">            :math:`(\Delta_{x_{i}} \mapsto \Delta_{x_{i+1}})` over</span>
<span class="sd">            each non-trivial assignment :math:`x_{i+1} \leftarrow f_i(x_i)`,</span>
<span class="sd">            computed from the `abstractproperty.opmodel.OpModel.decimal_weight`</span>
<span class="sd">            method of the `abstractproperty.opmodel.OpModel` objects stored in</span>
<span class="sd">            `tuple_assign_outprop2op_model`.</span>
<span class="sd">        empirical_ch_weight: the empirical weight of the characteristic</span>
<span class="sd">            (available after calling `compute_empirical_ch_weight`).</span>
<span class="sd">        empirical_data_list: a list of `EmpiricalWeightData` objects</span>
<span class="sd">            containing the auxiliary data of the empirical weight</span>
<span class="sd">            (see also `compute_empirical_ch_weight`).</span>
<span class="sd">        input_prop: a list of `Property` objects containing</span>
<span class="sd">            the (constant) input property.</span>
<span class="sd">        output_prop: a list of `Property` objects containing</span>
<span class="sd">            the (constant) output property.</span>
<span class="sd">        external_props: a list containing the (constant) `Property` of</span>
<span class="sd">            the external variables of the function.</span>
<span class="sd">        tuple_assign_outprop2op_model:  a tuple where each element is a pair</span>
<span class="sd">            containing: (1) the output (constant) `Property` :math:`\Delta_{x_{i+1}}`</span>
<span class="sd">            of the non-trivial assignment  :math:`x_{i+1} \leftarrow f_i(x_i)`</span>
<span class="sd">            and (2) the `abstractproperty.opmodel.OpModel` of this assignment with</span>
<span class="sd">            a (constant) input `Property` :math:`\Delta_{x_{i}}`.</span>
<span class="sd">        free_props: a list of (symbolic) `Property` objects of</span>
<span class="sd">            the `ch_model`, whose values do not affect the characteristic,</span>
<span class="sd">            and were replaced by constant properties in `input_prop`,</span>
<span class="sd">            `output_prop`, `external_props` or `tuple_assign_outprop2op_model`.</span>
<span class="sd">        var_prop2ct_prop: a `collections.OrderedDict` mapping each</span>
<span class="sd">            symbolic `Property` in the trail to its constant property.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_prop_label</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="Characteristic.get_properties_for_initialization"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.Characteristic.get_properties_for_initialization">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_properties_for_initialization</span><span class="p">(</span><span class="n">ch_model</span><span class="p">,</span> <span class="n">var2ct</span><span class="p">,</span> <span class="n">free_props</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the properties needed to initialize a `Characteristic` object.</span>

<span class="sd">        Given a `abstractproperty.chmodel.ChModel`</span>
<span class="sd">        and a dictionary mapping `Variable` objects</span>
<span class="sd">        (representing the symbolic properties) to their `Constant` values,</span>
<span class="sd">        this method returns the following objects: ``input_prop``,</span>
<span class="sd">        ``output_prop``, ``external_props`` and ``assign_outprop_list``</span>
<span class="sd">        for the ``Characteristic.__init__`` method.</span>

<span class="sd">        Symbolic properties not affecting the characteristics can be</span>
<span class="sd">        given in ``free_props`` and they will be set to 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch_model</span><span class="p">,</span> <span class="n">cascada_chmodel</span><span class="o">.</span><span class="n">ChModel</span><span class="p">)</span>

        <span class="n">var2ct</span> <span class="o">=</span> <span class="n">var2ct</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">var2ct</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid item (</span><span class="si">{</span><span class="n">v</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">c</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span><span class="si">}</span><span class="s2">) in var2ct = </span><span class="si">{</span><span class="n">var2ct</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">free_props</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">free_props</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">free_props</span> <span class="o">=</span> <span class="n">free_props</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">ssa</span><span class="o">.</span><span class="n">_input_vars_not_used</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var2ct</span><span class="p">:</span>
                <span class="n">var_prop</span> <span class="o">=</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">var_prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">free_props</span><span class="p">:</span>
                    <span class="n">free_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var_prop</span><span class="p">)</span>

        <span class="n">aux_intersection</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">var2ct</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">p</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">free_props</span><span class="p">]))</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux_intersection</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">aux_intersection</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">prop_str</span> <span class="o">=</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="n">input_prop</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var_prop</span> <span class="ow">in</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">input_prop</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var_prop</span><span class="o">.</span><span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var2ct</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">var_prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">free_props</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;input </span><span class="si">{</span><span class="n">prop_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_prop</span><span class="si">}</span><span class="s2"> not included in var2ct </span><span class="si">{</span><span class="n">var2ct</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ct_prop</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">var_prop</span><span class="p">)(</span><span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">var2ct</span><span class="p">[</span><span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
                <span class="n">ct_prop</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">var_prop</span><span class="p">)(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">input_prop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">)</span>

        <span class="n">external_props</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="p">:</span>
            <span class="n">var_prop</span> <span class="o">=</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">var_prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">free_props</span>
                <span class="n">ct_prop</span> <span class="o">=</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">var2ct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">ct_prop</span><span class="o">.</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="n">ct_prop</span><span class="o">.</span><span class="n">val</span>
                <span class="n">var2ct</span><span class="p">[</span><span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_prop</span><span class="o">.</span><span class="n">val</span>
            <span class="k">if</span> <span class="n">var_prop</span><span class="o">.</span><span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var2ct</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">var_prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">free_props</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;external </span><span class="si">{</span><span class="n">prop_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_prop</span><span class="si">}</span><span class="s2"> not included in var2ct </span><span class="si">{</span><span class="n">var2ct</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ct_prop</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">var_prop</span><span class="p">)(</span><span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">var2ct</span><span class="p">[</span><span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
                <span class="n">ct_prop</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">var_prop</span><span class="p">)(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">external_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">)</span>

        <span class="n">assign_outprop_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var_prop</span><span class="p">,</span> <span class="n">om</span> <span class="ow">in</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">assign_outprop2op_model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">var_prop</span><span class="o">.</span><span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var2ct</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">om</span><span class="p">,</span> <span class="n">cascada_opmodel</span><span class="o">.</span><span class="n">ModelIdentity</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">var_prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">free_props</span> <span class="ow">or</span> <span class="n">var_prop</span><span class="o">.</span><span class="n">val</span> <span class="ow">or</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">ssa</span><span class="o">.</span><span class="n">_input_vars_not_used</span>
                    <span class="n">ct_prop</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">var_prop</span><span class="p">)(</span><span class="n">om</span><span class="o">.</span><span class="n">input_prop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="n">var2ct</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">var_prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">free_props</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;assignment output </span><span class="si">{</span><span class="n">prop_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_prop</span><span class="si">}</span><span class="s2"> not included in var2ct </span><span class="si">{</span><span class="n">var2ct</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">ct_prop</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">var_prop</span><span class="p">)(</span><span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ct_prop</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">var2ct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">ct_prop</span><span class="o">.</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="n">ct_prop</span><span class="o">.</span><span class="n">val</span>
                <span class="n">var2ct</span><span class="p">[</span><span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_prop</span><span class="o">.</span><span class="n">val</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">var2ct</span><span class="p">[</span><span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
                <span class="n">ct_prop</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">var_prop</span><span class="p">)(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">assign_outprop_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">)</span>

        <span class="n">output_prop</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var_prop</span> <span class="ow">in</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">output_prop</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var_prop</span><span class="o">.</span><span class="n">val</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var2ct</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">var_prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">free_props</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;output </span><span class="si">{</span><span class="n">prop_str</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">var_prop</span><span class="si">}</span><span class="s2"> not included in var2ct </span><span class="si">{</span><span class="n">var2ct</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">ct_prop</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">var_prop</span><span class="p">)(</span><span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">var_prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">free_props</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">var2ct</span><span class="p">[</span><span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="p">]</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
                <span class="n">ct_prop</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">var_prop</span><span class="p">)(</span><span class="n">val</span><span class="p">)</span>
            <span class="n">output_prop</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">input_prop</span><span class="p">,</span> <span class="n">output_prop</span><span class="p">,</span> <span class="n">external_props</span><span class="p">,</span> <span class="n">assign_outprop_list</span></div>

    <span class="k">def</span> <span class="nf">_prop_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_prop</span><span class="p">,</span> <span class="n">output_prop</span><span class="p">,</span> <span class="n">assign_outprop_list</span><span class="p">,</span>
                   <span class="n">ch_model</span><span class="p">,</span> <span class="n">external_props</span><span class="p">,</span> <span class="n">free_props</span><span class="p">,</span>
                   <span class="n">empirical_ch_weight</span><span class="p">,</span> <span class="n">empirical_data_list</span><span class="p">,</span> <span class="n">is_valid</span><span class="p">):</span>
        <span class="c1"># auxiliary method called by __init__ and _prop_new (with &quot;prop&quot; labels in arguments)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch_model</span><span class="p">,</span> <span class="n">cascada_chmodel</span><span class="o">.</span><span class="n">ChModel</span><span class="p">)</span>

        <span class="n">input_prop</span> <span class="o">=</span> <span class="n">input_prop</span><span class="p">[:]</span>  <span class="c1"># [:] also works on tuples (.copy() not)</span>
        <span class="n">output_prop</span> <span class="o">=</span> <span class="n">output_prop</span><span class="p">[:]</span>
        <span class="n">assign_outprop_list</span> <span class="o">=</span> <span class="n">assign_outprop_list</span><span class="p">[:]</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_prop</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch_model</span><span class="o">.</span><span class="n">input_prop</span><span class="p">),</span> \
            <span class="sa">f</span><span class="s2">&quot;len(</span><span class="si">{</span><span class="n">input_prop</span><span class="si">}</span><span class="s2">) == len(</span><span class="si">{</span><span class="n">ch_model</span><span class="o">.</span><span class="n">input_prop</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ct_prop</span><span class="p">,</span> <span class="n">var_prop</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">input_prop</span><span class="p">,</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">input_prop</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">,</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
                <span class="n">ct_prop</span> <span class="o">=</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">)</span>
                <span class="n">input_prop</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_prop</span>
            <span class="k">assert</span> <span class="n">ct_prop</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">output_prop</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch_model</span><span class="o">.</span><span class="n">output_prop</span><span class="p">),</span> \
            <span class="sa">f</span><span class="s2">&quot;len(</span><span class="si">{</span><span class="n">output_prop</span><span class="si">}</span><span class="s2">) == len(</span><span class="si">{</span><span class="n">ch_model</span><span class="o">.</span><span class="n">output_prop</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ct_prop</span><span class="p">,</span> <span class="n">var_prop</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">output_prop</span><span class="p">,</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">output_prop</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">,</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
                <span class="n">ct_prop</span> <span class="o">=</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">)</span>
                <span class="n">output_prop</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_prop</span>
            <span class="k">assert</span> <span class="n">ct_prop</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">assign_outprop_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch_model</span><span class="o">.</span><span class="n">assign_outprop2op_model</span><span class="p">),</span> \
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">assign_outprop_list</span><span class="p">)</span><span class="si">}</span><span class="s2"> == </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ch_model</span><span class="o">.</span><span class="n">assign_outprop2op_model</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span> \
            <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">len(</span><span class="si">{</span><span class="n">assign_outprop_list</span><span class="si">}</span><span class="s2">) == len(</span><span class="si">{</span><span class="n">ch_model</span><span class="o">.</span><span class="n">assign_outprop2op_model</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ct_prop</span><span class="p">,</span> <span class="n">var_prop</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">assign_outprop_list</span><span class="p">,</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">assign_outprop2op_model</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">,</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
                <span class="n">ct_prop</span> <span class="o">=</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">)</span>
                <span class="n">assign_outprop_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_prop</span>
            <span class="k">assert</span> <span class="n">ct_prop</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span>

        <span class="k">if</span> <span class="n">external_props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">external_props</span> <span class="o">=</span> <span class="n">external_props</span><span class="p">[:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">external_props</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">external_props</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="p">),</span> \
            <span class="sa">f</span><span class="s2">&quot;len(</span><span class="si">{</span><span class="n">external_props</span><span class="si">}</span><span class="s2">) == len(</span><span class="si">{</span><span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">external_props</span><span class="p">,</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
                <span class="n">prop</span> <span class="o">=</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
                <span class="n">external_props</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">prop</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;external_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_prop_label</span><span class="si">}</span><span class="s2">s[i] = </span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2"> is not constant&quot;</span><span class="p">)</span>
            <span class="n">aux_prop</span> <span class="o">=</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">aux_prop</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span> <span class="ow">and</span> <span class="n">prop</span> <span class="o">!=</span> <span class="n">aux_prop</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;external_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_prop_label</span><span class="si">}</span><span class="s2">s[i] = </span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2"> != &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">aux_prop</span><span class="si">}</span><span class="s2"> = external_var2</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_prop_label</span><span class="si">}</span><span class="s2">[</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">free_props</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">free_props</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">free_props</span> <span class="o">=</span> <span class="n">free_props</span><span class="p">[:]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">prop</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">free_props</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">):</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">)</span>
                <span class="n">free_props</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="p">,</span> <span class="nb">property</span><span class="o">.</span><span class="n">Property</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">prop</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">)</span>
        <span class="n">aux_iv_fp</span> <span class="o">=</span> <span class="p">[</span><span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">ssa</span><span class="o">.</span><span class="n">_input_vars_not_used</span><span class="p">]</span>
        <span class="n">free_props</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">aux_iv_fp</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">free_props</span><span class="p">]</span> <span class="o">+</span> <span class="n">free_props</span>
        <span class="n">free_props_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">free_props</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span> <span class="o">=</span> <span class="n">ch_model</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">input_prop</span> <span class="o">=</span> <span class="n">input_prop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_prop</span> <span class="o">=</span> <span class="n">output_prop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">external_props</span> <span class="o">=</span> <span class="n">external_props</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">free_props</span> <span class="o">=</span> <span class="n">free_props</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">var_prop2ct_prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_var_prop2ct_prop</span><span class="p">(</span><span class="n">assign_outprop_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tuple_assign_outprop2op_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_assign_outprop2op_model</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid</span> <span class="o">=</span> <span class="n">is_valid</span>  <span class="c1"># store before _get_ch_assignment_weights_and_check</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_ch_assignment_weights_and_check</span><span class="p">()</span>

        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">Simplification</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">var2ct</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_prop2ct_prop</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">validity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">validity_assertions</span><span class="p">()</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">free_props_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">assertion</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">))</span> <span class="k">for</span> <span class="n">assertion</span> <span class="ow">in</span> <span class="n">validity</span><span class="p">)</span>
            <span class="n">validity</span> <span class="o">=</span> <span class="p">[</span><span class="n">assertion</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="n">var2ct</span><span class="p">)</span> <span class="k">for</span> <span class="n">assertion</span> <span class="ow">in</span> <span class="n">validity</span><span class="p">]</span>
            <span class="n">validity</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">BvAnd</span><span class="p">,</span> <span class="n">validity</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">validity</span> <span class="o">==</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">is_valid</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">cascada_opmodel</span><span class="o">.</span><span class="n">InvalidOpModelError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;is_valid = </span><span class="si">{</span><span class="n">is_valid</span><span class="si">}</span><span class="s2"> but ch_model.validity_assertions() = </span><span class="si">{</span><span class="n">validity</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">validity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]:</span>
                <span class="n">set_evs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">external_vars_validity_assertions</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">validity</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_evs</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unknown variable </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> in validity_assertions</span><span class="se">\n</span><span class="s2">ch_model: &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="si">}</span><span class="se">\n</span><span class="s2">ch_model.validity_assertions(): </span><span class="si">{</span><span class="n">validity</span><span class="si">}</span><span class="s2">&quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">known assertion external variables: </span><span class="si">{</span><span class="n">set_evs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">pr_one</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">pr_one_assertions</span><span class="p">()</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">free_props_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">assertion</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">))</span> <span class="k">for</span> <span class="n">assertion</span> <span class="ow">in</span> <span class="n">pr_one</span><span class="p">)</span>
            <span class="n">pr_one</span> <span class="o">=</span> <span class="p">[</span><span class="n">assertion</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="n">var2ct</span><span class="p">)</span> <span class="k">for</span> <span class="n">assertion</span> <span class="ow">in</span> <span class="n">pr_one</span><span class="p">]</span>
            <span class="n">pr_one</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">BvAnd</span><span class="p">,</span> <span class="n">pr_one</span><span class="p">)</span>
            <span class="n">has_pr_one</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">pr_one</span> <span class="o">==</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="ow">not</span> <span class="n">has_pr_one</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="ow">not</span> <span class="n">has_pr_one</span><span class="si">}</span><span class="s2"> == ch_model.pr_one_assertions() but weight = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">pr_one</span> <span class="o">!=</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">set_evs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">external_vars_pr_one_assertions</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pr_one</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_evs</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unknown variable </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> in pr_one_assertions</span><span class="se">\n</span><span class="s2">ch_model: &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="si">}</span><span class="se">\n</span><span class="s2">ch_model.pr_one_assertions(): </span><span class="si">{</span><span class="n">pr_one</span><span class="si">}</span><span class="s2">&quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">known assertion external variables: </span><span class="si">{</span><span class="n">set_evs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="p">(</span><span class="n">empirical_ch_weight</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">empirical_data_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>
        <span class="c1"># only checks involving both empirical_ch_weight and empirical_data_list</span>
        <span class="k">if</span> <span class="n">empirical_ch_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ewd</span><span class="p">,</span> <span class="n">EmpiricalWeightData</span><span class="p">)</span> <span class="k">for</span> <span class="n">ewd</span> <span class="ow">in</span> <span class="n">empirical_data_list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">empirical_ch_weight</span> <span class="o">=</span> <span class="n">empirical_ch_weight</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">empirical_data_list</span> <span class="o">=</span> <span class="n">empirical_data_list</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_prop</span><span class="p">,</span> <span class="n">output_prop</span><span class="p">,</span> <span class="n">assign_outprop_list</span><span class="p">,</span>
                 <span class="n">ch_model</span><span class="p">,</span> <span class="n">external_props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">free_props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">empirical_ch_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">empirical_data_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_prop_init</span><span class="p">(</span>
            <span class="n">input_prop</span><span class="o">=</span><span class="n">input_prop</span><span class="p">,</span> <span class="n">output_prop</span><span class="o">=</span><span class="n">output_prop</span><span class="p">,</span> <span class="n">assign_outprop_list</span><span class="o">=</span><span class="n">assign_outprop_list</span><span class="p">,</span>
            <span class="n">ch_model</span><span class="o">=</span><span class="n">ch_model</span><span class="p">,</span> <span class="n">external_props</span><span class="o">=</span><span class="n">external_props</span><span class="p">,</span> <span class="n">free_props</span><span class="o">=</span><span class="n">free_props</span><span class="p">,</span>
            <span class="n">empirical_ch_weight</span><span class="o">=</span><span class="n">empirical_ch_weight</span><span class="p">,</span> <span class="n">empirical_data_list</span><span class="o">=</span><span class="n">empirical_data_list</span><span class="p">,</span> <span class="n">is_valid</span><span class="o">=</span><span class="n">is_valid</span>
        <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_prop_new</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">input_prop</span><span class="p">,</span> <span class="n">output_prop</span><span class="p">,</span> <span class="n">assign_outprop_list</span><span class="p">,</span>
                  <span class="n">ch_model</span><span class="p">,</span> <span class="n">external_props</span><span class="p">,</span> <span class="n">free_props</span><span class="p">,</span>
                  <span class="n">empirical_ch_weight</span><span class="p">,</span> <span class="n">empirical_data_list</span><span class="p">,</span> <span class="n">is_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># create a new object with &quot;prop&quot; labels in arguments</span>
        <span class="c1"># (__init__ argument names might be overridden)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>  <span class="c1"># does not call __init__</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">_prop_init</span><span class="p">(</span>
            <span class="n">input_prop</span><span class="o">=</span><span class="n">input_prop</span><span class="p">,</span> <span class="n">output_prop</span><span class="o">=</span><span class="n">output_prop</span><span class="p">,</span> <span class="n">assign_outprop_list</span><span class="o">=</span><span class="n">assign_outprop_list</span><span class="p">,</span>
            <span class="n">ch_model</span><span class="o">=</span><span class="n">ch_model</span><span class="p">,</span> <span class="n">external_props</span><span class="o">=</span><span class="n">external_props</span><span class="p">,</span> <span class="n">free_props</span><span class="o">=</span><span class="n">free_props</span><span class="p">,</span>
            <span class="n">empirical_ch_weight</span><span class="o">=</span><span class="n">empirical_ch_weight</span><span class="p">,</span> <span class="n">empirical_data_list</span><span class="o">=</span><span class="n">empirical_data_list</span><span class="p">,</span> <span class="n">is_valid</span><span class="o">=</span><span class="n">is_valid</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">_get_var_prop2ct_prop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">assign_outprop_list</span><span class="p">):</span>
        <span class="n">var_prop2ct_prop</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">ct_prop</span><span class="p">,</span> <span class="n">var_prop</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">input_prop</span><span class="p">):</span>
            <span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="n">var_prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_prop</span>
        <span class="k">for</span> <span class="n">ct_prop</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">external_props</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="p">):</span>
            <span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ct_prop</span>

        <span class="n">extra_var_prop2ct_prop</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">ct_prop</span><span class="p">,</span> <span class="n">var_prop</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">assign_outprop_list</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">assign_outprop2op_model</span><span class="p">):</span>
            <span class="n">extra_var_prop2ct_prop</span><span class="p">[</span><span class="n">var_prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_prop</span>

        <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">var_prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">var2prop</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">var</span><span class="p">)</span> <span class="ow">in</span> <span class="n">var_prop2ct_prop</span><span class="p">:</span>
                <span class="c1"># ignore input and external prop already processed</span>
                <span class="k">continue</span>
            <span class="c1"># second dictionary&#39;s values overwriting those from the first.</span>
            <span class="n">ct_prop</span> <span class="o">=</span> <span class="n">var_prop</span><span class="o">.</span><span class="n">xreplace</span><span class="p">({</span><span class="o">**</span><span class="n">extra_var_prop2ct_prop</span><span class="p">,</span> <span class="o">**</span><span class="n">var_prop2ct_prop</span><span class="p">})</span>
            <span class="c1"># for v in ct_prop.val.atoms(core.Variable):</span>
            <span class="c1">#     assert v in self.ch_model.ssa.external_vars</span>
            <span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ct_prop</span>

        <span class="c1"># check var_prop2ct_prop is consistent with input/output_prop and assign_outprop_list</span>
        <span class="n">my_zip</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">input_prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_prop</span><span class="p">,</span> <span class="n">assign_outprop_list</span><span class="p">],</span>
                     <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">input_prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">output_prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">assign_outprop2op_model</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">ct_prop_list</span><span class="p">,</span> <span class="n">var_prop_list</span> <span class="ow">in</span> <span class="n">my_zip</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">ct_prop</span><span class="p">,</span> <span class="n">var_prop</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">ct_prop_list</span><span class="p">,</span> <span class="n">var_prop_list</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="n">var_prop</span><span class="p">]</span> <span class="o">==</span> <span class="n">ct_prop</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="n">var_prop</span><span class="p">]</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">ct_prop</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">var_prop2ct_prop</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">var_prop2ct_prop</span>

    <span class="k">def</span> <span class="nf">_get_assign_outprop2op_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">assign_outprop_op_model</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">outprop_var</span><span class="p">,</span> <span class="n">op_model_symbolic</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">assign_outprop2op_model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">inprop_ct</span> <span class="o">=</span> <span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_prop2ct_prop</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">op_model_symbolic</span><span class="o">.</span><span class="n">input_prop</span><span class="p">]</span>
            <span class="n">op_model_ct</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">op_model_symbolic</span><span class="p">)(</span><span class="n">inprop_ct</span><span class="p">)</span>
            <span class="n">outprop_ct</span> <span class="o">=</span> <span class="n">outprop_var</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_prop2ct_prop</span><span class="p">)</span>
            <span class="n">assign_outprop_op_model</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">outprop_ct</span><span class="p">,</span> <span class="n">op_model_ct</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">assign_outprop_op_model</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_ch_assignment_weights_and_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ch_weight</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">assignment_weights</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">outprop</span><span class="p">,</span> <span class="n">op_model</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuple_assign_outprop2op_model</span><span class="p">):</span>
            <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">Simplification</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span> <span class="n">context</span><span class="o">.</span><span class="n">Cache</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">validity</span> <span class="o">=</span> <span class="n">op_model</span><span class="o">.</span><span class="n">validity_constraint</span><span class="p">(</span><span class="n">outprop</span><span class="p">)</span>
                <span class="n">pr_one</span> <span class="o">=</span> <span class="n">op_model</span><span class="o">.</span><span class="n">pr_one_constraint</span><span class="p">(</span><span class="n">outprop</span><span class="p">)</span>

            <span class="c1"># quick check for validity and pr_one</span>
            <span class="n">set_evs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">op_model</span><span class="o">.</span><span class="n">external_vars_validity_constraint</span><span class="p">(</span><span class="n">outprop</span><span class="p">))</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">set_evs</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">validity</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">))</span>
            <span class="n">set_evs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">op_model</span><span class="o">.</span><span class="n">external_vars_pr_one_constraint</span><span class="p">(</span><span class="n">outprop</span><span class="p">))</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">set_evs</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">pr_one</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">))</span>
            <span class="k">assert</span> <span class="ow">not</span><span class="p">(</span><span class="n">pr_one</span> <span class="o">==</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="ow">and</span> <span class="n">validity</span> <span class="o">==</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="n">invalid_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;the characteristic was initialized with is_valid=True but it &quot;</span>\
                          <span class="sa">f</span><span class="s2">&quot;contains an invalid propagation </span><span class="si">{</span><span class="n">outprop</span><span class="si">}</span><span class="s2"> &lt;- </span><span class="si">{</span><span class="n">op_model</span><span class="si">}</span><span class="s2"> &quot;</span> \
                          <span class="sa">f</span><span class="s2">&quot;(False == validity_constraint())&quot;</span>

            <span class="k">if</span> <span class="n">validity</span> <span class="o">==</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">cascada_opmodel</span><span class="o">.</span><span class="n">InvalidOpModelError</span><span class="p">(</span><span class="n">invalid_msg</span><span class="p">)</span>
                <span class="n">aw</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">aw</span> <span class="o">=</span> <span class="n">op_model</span><span class="o">.</span><span class="n">decimal_weight</span><span class="p">(</span><span class="n">outprop</span><span class="p">)</span>
                <span class="k">except</span> <span class="n">cascada_opmodel</span><span class="o">.</span><span class="n">InvalidOpModelError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">cascada_opmodel</span><span class="o">.</span><span class="n">InvalidOpModelError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">invalid_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="n">aw</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>

                <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">aw</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">pr_one</span> <span class="o">==</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">aw</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span> <span class="ow">and</span> <span class="n">pr_one</span> <span class="o">==</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span> <span class="ow">in</span> <span class="p">[</span><span class="n">aw</span><span class="p">,</span> <span class="n">ch_weight</span><span class="p">]:</span>
                <span class="c1"># id adding math.inf (float) and aw (decimal)</span>
                <span class="n">ch_weight</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ch_weight</span> <span class="o">+=</span> <span class="n">aw</span>

            <span class="c1"># print(f&quot; - i, aw, error, fb, (outprop, op_model): {i}, {aw:.2f}, &quot;</span>
            <span class="c1">#       f&quot;{op_model.error():.2f}, {op_model.num_frac_bits()}, {outprop, op_model}&quot;)</span>

            <span class="n">assignment_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">aw</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid</span> <span class="o">!=</span> <span class="p">(</span><span class="n">ch_weight</span> <span class="o">!=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;weight = </span><span class="si">{</span><span class="n">ch_weight</span><span class="si">}</span><span class="s2"> but is_valid = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_valid</span><span class="si">}</span><span class="s2"> was given&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ch_weight</span><span class="p">,</span> <span class="n">assignment_weights</span>

    <span class="k">def</span> <span class="nf">_check_bv_weights</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bv_ch_weight</span><span class="p">,</span> <span class="n">bv_assignment_weights</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># if some OpModel is not valid, its bv_assignment_weight</span>
        <span class="c1"># (and bv_ch_weight) must be math.inf or None</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">bv_assignment_weights</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuple_assign_outprop2op_model</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">outprop</span><span class="p">,</span> <span class="n">op_model</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuple_assign_outprop2op_model</span><span class="p">):</span>
            <span class="n">bv_aw</span> <span class="o">=</span> <span class="n">bv_assignment_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">bv_aw</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bv_aw</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;assignment_weights[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] == math.inf but&quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;bv_assignment_weights[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] == </span><span class="si">{</span><span class="n">bv_aw</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bv_aw</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
                <span class="k">assert</span> <span class="n">bv_aw</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">op_model</span><span class="o">.</span><span class="n">weight_width</span><span class="p">()</span>
                <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">bv_aw</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">op_model</span><span class="o">.</span><span class="n">max_weight</span><span class="p">()</span>
                <span class="n">bv_aw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">bv_aw</span><span class="p">)</span> <span class="o">/</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">op_model</span><span class="o">.</span><span class="n">num_frac_bits</span><span class="p">())</span>
                <span class="n">decimal_aw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">abs_error</span> <span class="o">=</span> <span class="p">(</span><span class="n">bv_aw</span> <span class="o">-</span> <span class="n">decimal_aw</span><span class="p">)</span><span class="o">.</span><span class="n">copy_abs</span><span class="p">()</span>
                <span class="n">max_abs_error</span> <span class="o">=</span> <span class="n">op_model</span><span class="o">.</span><span class="n">error</span><span class="p">()</span>
                <span class="n">max_abs_error</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">max_abs_error</span><span class="p">)</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span>
                    <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1.&quot;</span> <span class="o">+</span> <span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">getcontext</span><span class="p">()</span><span class="o">.</span><span class="n">prec</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)),</span>
                    <span class="n">rounding</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">ROUND_UP</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">abs_error</span> <span class="o">&gt;</span> <span class="n">max_abs_error</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;absolute error for </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-th model </span><span class="si">{</span><span class="n">op_model</span><span class="si">}</span><span class="s2"> between &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;bit-vector assignment weight </span><span class="si">{</span><span class="n">bv_aw</span><span class="si">}</span><span class="s2"> (w/o frac bits) and &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;decimal assignment weight </span><span class="si">{</span><span class="n">decimal_aw</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">abs_error</span><span class="si">}</span><span class="s2">, &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;which is greater than maximum absolute error &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;given by op_model.error()=</span><span class="si">{</span><span class="n">max_abs_error</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">bv_ch_weight</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">bv_ch_weight</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ch_weight == </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="si">}</span><span class="s2"> but bv_ch_weight is </span><span class="si">{</span><span class="n">bv_ch_weight</span><span class="si">}</span><span class="s2">&quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot; and is_valid is </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_valid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># rest of method assume self._is_valid</span>

        <span class="n">max_fb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">num_frac_bits</span><span class="p">()</span>
        <span class="n">abs_error</span> <span class="o">=</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">bv_ch_weight</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">)</span><span class="o">.</span><span class="n">copy_abs</span><span class="p">()</span>
        <span class="n">max_abs_error</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">error</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">truncate</span><span class="p">:</span>
            <span class="c1"># extra error due to truncate=True</span>
            <span class="c1"># e.g., if fb=2, max error = 0.11b (= 0.75 decimal) = 1 - 2**2</span>
            <span class="c1"># last factor to avoid Python decimal error</span>
            <span class="n">extra_error</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="n">max_fb</span><span class="p">))</span>
            <span class="k">assert</span> <span class="ow">not</span> <span class="p">(</span><span class="n">max_fb</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">extra_error</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">max_abs_error</span> <span class="o">+=</span> <span class="n">extra_error</span>
        <span class="n">max_abs_error</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">max_abs_error</span><span class="p">)</span><span class="o">.</span><span class="n">quantize</span><span class="p">(</span>
            <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="s2">&quot;1.&quot;</span> <span class="o">+</span> <span class="s2">&quot;0&quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">decimal</span><span class="o">.</span><span class="n">getcontext</span><span class="p">()</span><span class="o">.</span><span class="n">prec</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)),</span> <span class="n">rounding</span><span class="o">=</span><span class="n">decimal</span><span class="o">.</span><span class="n">ROUND_UP</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">abs_error</span> <span class="o">&gt;</span> <span class="n">max_abs_error</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;absolute error between bit-vector ch. weight </span><span class="si">{</span><span class="n">bv_ch_weight</span><span class="si">}</span><span class="s2"> &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;(truncate=</span><span class="si">{</span><span class="n">truncate</span><span class="si">}</span><span class="s2">) and decimal weight </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">abs_error</span><span class="si">}</span><span class="s2">, &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;which is greater than maximum absolute error given by &quot;</span>
                             <span class="sa">f</span><span class="s2">&quot;ch_model.error()=</span><span class="si">{</span><span class="n">max_abs_error</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">zero_ext_right</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">num_zeros</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Expand with zeros to the right.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">var</span> <span class="k">if</span> <span class="n">num_zeros</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">operation</span><span class="o">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_zeros</span><span class="p">))</span>

        <span class="c1"># extracted from weight_assertions</span>
        <span class="c1"># max_fb = self.ch_model.num_frac_bits()</span>
        <span class="n">max_width_wo_truncate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">weight_width</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">aw_with_max_fb_and_width</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">op_model</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tuple_assign_outprop2op_model</span><span class="p">):</span>
            <span class="n">bv_aw</span> <span class="o">=</span> <span class="n">bv_assignment_weights</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">bv_aw</span> <span class="o">=</span> <span class="n">zero_ext_right</span><span class="p">(</span><span class="n">bv_aw</span><span class="p">,</span> <span class="n">max_fb</span> <span class="o">-</span> <span class="n">op_model</span><span class="o">.</span><span class="n">num_frac_bits</span><span class="p">())</span>
            <span class="n">bv_aw</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">zero_extend</span><span class="p">(</span><span class="n">bv_aw</span><span class="p">,</span> <span class="n">max_width_wo_truncate</span> <span class="o">-</span> <span class="n">bv_aw</span><span class="o">.</span><span class="n">width</span><span class="p">)</span>
            <span class="n">aw_with_max_fb_and_width</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bv_aw</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">aw_with_max_fb_and_width</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sum_aw</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">aw_with_max_fb_and_width</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">max_fb</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="n">sum_aw</span> <span class="o">=</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">truncate</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">max_fb</span> <span class="o">&gt;=</span> <span class="n">sum_aw</span><span class="o">.</span><span class="n">width</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">sum_aw</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">aux_max_weight</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">max_weight</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">/</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">max_fb</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="mi">0</span> <span class="o">&lt;</span> <span class="n">aux_max_weight</span> <span class="o">&lt;</span> <span class="mi">1</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_check_bv_weights(..., truncate=True) cannot truncate characteristic weight&quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot; with 0 &lt; </span><span class="si">{</span><span class="n">aux_max_weight</span><span class="si">}</span><span class="s2">=(max_weight(truncate=False) / num_frac_bits()) &lt; 1&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sum_aw</span> <span class="o">=</span> <span class="n">sum_aw</span><span class="p">[:</span><span class="n">max_fb</span><span class="p">]</span>

        <span class="k">assert</span> <span class="n">bv_ch_weight</span> <span class="o">==</span> <span class="n">sum_aw</span>
        <span class="k">assert</span> <span class="n">bv_ch_weight</span><span class="o">.</span><span class="n">width</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">weight_width</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="n">truncate</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">int</span><span class="p">(</span><span class="n">bv_ch_weight</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">max_weight</span><span class="p">(</span><span class="n">truncate</span><span class="o">=</span><span class="n">truncate</span><span class="p">)</span>

        <span class="n">free_props_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">free_props</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">Simplification</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">var2ct</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="p">:</span> <span class="n">d</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_prop2ct_prop</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">wa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">weight_assertions</span><span class="p">(</span><span class="n">bv_ch_weight</span><span class="p">,</span> <span class="n">bv_assignment_weights</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="ow">not</span> <span class="n">free_props_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">assertion</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">))</span> <span class="k">for</span> <span class="n">assertion</span> <span class="ow">in</span> <span class="n">wa</span><span class="p">)</span>
            <span class="n">wa</span> <span class="o">=</span> <span class="p">[</span><span class="n">assertion</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="n">var2ct</span><span class="p">)</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="n">var2ct</span><span class="p">)</span> <span class="k">for</span> <span class="n">assertion</span> <span class="ow">in</span> <span class="n">wa</span><span class="p">]</span>
            <span class="n">wa</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">operation</span><span class="o">.</span><span class="n">BvAnd</span><span class="p">,</span> <span class="n">wa</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;is_valid = </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_valid</span><span class="si">}</span><span class="s2"> but False == &quot;</span>
                                 <span class="sa">f</span><span class="s2">&quot;ch_model.weight_assertions(</span><span class="si">{</span><span class="n">bv_ch_weight</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">bv_assignment_weights</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">wa</span> <span class="o">!=</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">set_evs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">external_vars_weight_assertions</span><span class="p">(</span><span class="n">bv_assignment_weights</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">wa</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">set_evs</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;unknown variable </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> in weight_assertions</span><span class="se">\n</span><span class="s2">ch_model: &quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="si">}</span><span class="se">\n</span><span class="s2">ch_model.weight_assertions(): </span><span class="si">{</span><span class="n">wa</span><span class="si">}</span><span class="s2">&quot;</span>
                                         <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">known assertion external variables: </span><span class="si">{</span><span class="n">set_evs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empirical_data_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">edl_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">empirical_data_list</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_prop_label</span>
        <span class="n">format_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{}}</span><span class="s2">(ch_weight=</span><span class="se">{{}}{{}}</span><span class="s2">, assignment_weights=</span><span class="se">{{}}</span><span class="s2">, &quot;</span> \
                     <span class="sa">f</span><span class="s2">&quot;input_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">=</span><span class="se">{{}}</span><span class="s2">, output_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">=</span><span class="se">{{}}{{}}</span><span class="s2">, assign_out</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">_list=</span><span class="se">{{}}{{}}</span><span class="s2">)&quot;</span>
        <span class="k">return</span> <span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empirical_ch_weight</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, empirical_ch_weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">empirical_ch_weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="c1"># str(self.input_prop) ignored to print it in a list-like way</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_weights</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_prop</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_prop</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_props</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, external_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">s=[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_props</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuple_assign_outprop2op_model</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_props</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, free_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">s=[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_props</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empirical_data_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, empirical_data_list=</span><span class="si">{</span><span class="n">edl_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="fm">__repr__</span> <span class="o">=</span> <span class="fm">__str__</span>

<div class="viewcode-block" id="Characteristic.vrepr"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.Characteristic.vrepr">[docs]</a>    <span class="k">def</span> <span class="nf">vrepr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_external_props</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an executable string representation.</span>

<span class="sd">        This method returns a string so that ``eval(self.vrepr())``</span>
<span class="sd">        returns a new `Characteristic` object with the same content.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empirical_data_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">edl_vrepr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">empirical_data_list</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="c1"># using v.val.vrepr() instead of v.vrepr() since __init__ allows Constant</span>
        <span class="c1"># or Property(Constant) and the former is easier</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_prop_label</span>
        <span class="n">format_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{}}</span><span class="s2">(input_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">=</span><span class="se">{{}}</span><span class="s2">, output_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">=</span><span class="se">{{}}</span><span class="s2">, &quot;</span> \
                     <span class="sa">f</span><span class="s2">&quot;assign_out</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">_list=</span><span class="se">{{}}</span><span class="s2">, ch_model=</span><span class="se">{{}}{{}}{{}}{{}}{{}}{{}}</span><span class="s2">)&quot;</span>
        <span class="k">return</span> <span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_prop</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_prop</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuple_assign_outprop2op_model</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">vrepr</span><span class="p">(),</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">ignore_external_props</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_props</span> <span class="k">else</span>
                <span class="sa">f</span><span class="s2">&quot;, external_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">s=[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_props</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_props</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, free_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">s=[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_props</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empirical_ch_weight</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, empirical_ch_weight=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">empirical_ch_weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empirical_data_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, empirical_data_list=</span><span class="si">{</span><span class="n">edl_vrepr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_valid</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, is_valid=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_is_valid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Characteristic.srepr"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.Characteristic.srepr">[docs]</a>    <span class="k">def</span> <span class="nf">srepr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a short string representation of the characteristic.</span>

<span class="sd">        The short representation includes the characteristic weight rounded up</span>
<span class="sd">        to 3 fractional digits (and similar for the empirical weight if defined)</span>
<span class="sd">        and the input and output properties, printed in hexadecimal</span>
<span class="sd">        but omitting the prefix ``0x``.</span>

<span class="sd">        Doctest included in `vrepr`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">to_hex_or_bin</span><span class="p">(</span><span class="n">my_bv</span><span class="p">):</span>
            <span class="n">my_bv</span> <span class="o">=</span> <span class="n">my_bv</span><span class="o">.</span><span class="n">val</span>  <span class="c1"># my_bv is a Property object</span>
            <span class="k">if</span> <span class="n">my_bv</span><span class="o">.</span><span class="n">width</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">my_bv</span> <span class="o">=</span> <span class="n">operation</span><span class="o">.</span><span class="n">Concat</span><span class="p">(</span><span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">(</span><span class="n">my_bv</span><span class="o">.</span><span class="n">width</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)),</span> <span class="n">my_bv</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">my_bv</span><span class="o">.</span><span class="n">hex</span><span class="p">()[</span><span class="mi">2</span><span class="p">:]</span>  <span class="c1"># remove 0x</span>

        <span class="n">num_frac_digits</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">my_context</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Context</span><span class="p">(</span><span class="n">prec</span><span class="o">=</span><span class="n">num_frac_digits</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ch_weight</span> <span class="o">=</span> <span class="n">my_context</span><span class="o">.</span><span class="n">create_decimal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empirical_ch_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empirical_ch_weight</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                <span class="n">empirical_ch_weight</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">empirical_ch_weight</span> <span class="o">=</span> <span class="n">my_context</span><span class="o">.</span><span class="n">create_decimal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">empirical_ch_weight</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">empirical_ch_weight</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">input_prop</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">to_hex_or_bin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_prop</span><span class="p">])</span>
        <span class="n">output_prop</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">to_hex_or_bin</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_prop</span><span class="p">])</span>
        <span class="k">return</span> <span class="s2">&quot;Ch(w=</span><span class="si">{}{}</span><span class="s2">, id=</span><span class="si">{}</span><span class="s2">, od=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">ch_weight</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empirical_ch_weight</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, ew=</span><span class="si">{</span><span class="n">empirical_ch_weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">input_prop</span><span class="p">,</span>
            <span class="n">output_prop</span><span class="p">)</span></div>

<div class="viewcode-block" id="Characteristic.signature"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.Characteristic.signature">[docs]</a>    <span class="k">def</span> <span class="nf">signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch_signature_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the signature of the characteristic.</span>

<span class="sd">        This method is similar that `abstractproperty.chmodel.ChModel.signature`</span>
<span class="sd">        but for non-symbolic characteristic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">symbolic_sig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">ch_signature_type</span><span class="p">)</span>
        <span class="n">ct_sig</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">symbolic_sig</span><span class="p">:</span>
            <span class="n">ct_sig</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">var_prop2ct_prop</span><span class="p">)</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ct_sig</span></div>

<div class="viewcode-block" id="Characteristic.split"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.Characteristic.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop_separators</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split into multiple `Characteristic` objects given the list of property separators.</span>

<span class="sd">        Given the `Characteristic` :math:`c`, this method returns a list of characteristics</span>
<span class="sd">        :math:`c_1, c_2, ..., c_n`, such that their composition is equal to</span>
<span class="sd">        the main characteristic :math:`c`.</span>

<span class="sd">        The argument ``prop_separators`` is a list containing lists of symbolic properties.</span>
<span class="sd">        The :math:`i`-th property list denote the last properties of the</span>
<span class="sd">        :math:`i`-th `abstractproperty.chmodel.ChModel`.</span>
<span class="sd">        In other words, the :math:`(i+1)`-th characteristic</span>
<span class="sd">        immediately starts after the last property in ``prop_separators[i]``.</span>

<span class="sd">        To split into :math:`n` characteristics, ``prop_separators`` must contain</span>
<span class="sd">        :math:`n-1` lists, as the property list of the last characteristic is not given</span>
<span class="sd">        (its last properties are the output properties of the main characteristic).</span>

<span class="sd">        This method internally calls `abstractproperty.chmodel.ChModel.split` to</span>
<span class="sd">        split the underlying characteristic model `ch_model`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sub_chmodel_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">prop_separators</span><span class="p">)</span>

        <span class="k">class</span> <span class="nc">SubCh</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="n">self_ch</span><span class="p">,</span> <span class="n">sub_chmodel</span><span class="p">):</span>
                <span class="n">self_ch</span><span class="o">.</span><span class="n">input_prop</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">self_ch</span><span class="o">.</span><span class="n">output_prop</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">self_ch</span><span class="o">.</span><span class="n">assign_outprop_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">self_ch</span><span class="o">.</span><span class="n">ch_model</span> <span class="o">=</span> <span class="n">sub_chmodel</span>
                <span class="n">self_ch</span><span class="o">.</span><span class="n">external_props</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">self_ch</span><span class="o">.</span><span class="n">free_props</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="n">self_ch</span><span class="p">):</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;SubCh:&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - input_prop: </span><span class="si">{</span><span class="n">self_ch</span><span class="o">.</span><span class="n">input_prop</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - output_prop: </span><span class="si">{</span><span class="n">self_ch</span><span class="o">.</span><span class="n">output_prop</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - assign_outprop_list: </span><span class="si">{</span><span class="n">self_ch</span><span class="o">.</span><span class="n">assign_outprop_list</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - external_props: </span><span class="si">{</span><span class="n">self_ch</span><span class="o">.</span><span class="n">external_props</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - free_props: </span><span class="si">{</span><span class="n">self_ch</span><span class="o">.</span><span class="n">free_props</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2"> - ch_model: </span><span class="si">{</span><span class="n">self_ch</span><span class="o">.</span><span class="n">ch_model</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">return</span> <span class="n">msg</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_chmodel_list</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">prop_separators</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">sub_ch_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">SubCh</span><span class="p">(</span><span class="n">sub_chmodel_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">prop_separators</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>

        <span class="c1"># old_om2ct_op_om maps OpModel from the parent ChModel to (ct) OpModel from the parent Characteristic</span>
        <span class="c1"># (old) only refers to OpModel from the parent ChModel (!= from OpModel from SubChModels)</span>
        <span class="c1"># (ct OpModel from the parent Characteristic == ct OpModel from SubCh)</span>
        <span class="n">old_om2ct_op_om</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">old_om</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">assign_outprop2op_model</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old_om</span><span class="p">,</span> <span class="n">cascada_opmodel</span><span class="o">.</span><span class="n">ModelIdentity</span><span class="p">):</span>
                <span class="n">old_om2ct_op_om</span><span class="p">[</span><span class="n">old_om</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuple_assign_outprop2op_model</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

        <span class="c1"># new_om2old_om maps OpModel from the SubChModel to OpModel from the parent ChModel</span>
        <span class="n">old_om_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">old_om2ct_op_om</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">new_om2old_om</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sub_ch</span> <span class="ow">in</span> <span class="n">sub_ch_list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">new_om</span> <span class="ow">in</span> <span class="n">sub_ch</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">assign_outprop2op_model</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_om</span><span class="p">,</span> <span class="n">cascada_opmodel</span><span class="o">.</span><span class="n">ModelIdentity</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">new_om</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_om2old_om</span>
                    <span class="n">old_om</span> <span class="o">=</span> <span class="n">old_om_list</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">new_om2old_om</span><span class="p">)]</span>
                    <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">new_om</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="n">old_om</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">old_om</span><span class="si">}</span><span class="s2"> != </span><span class="si">{</span><span class="n">new_om</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="n">new_om2old_om</span><span class="p">[</span><span class="n">new_om</span><span class="p">]</span> <span class="o">=</span> <span class="n">old_om</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">old_om2ct_op_om</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_om2old_om</span><span class="p">)</span>

        <span class="n">aux_free_props</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sub_ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sub_ch_list</span><span class="p">):</span>
            <span class="c1"># if i == 0:</span>
            <span class="c1">#     print(&quot;# Main Characteristic and ChModel&quot;)</span>
            <span class="c1">#     print(self)</span>
            <span class="c1">#     print(self.ch_model)</span>
            <span class="c1">#     print(self.ch_model.ssa)</span>
            <span class="c1"># print(f&quot;\n# Computing sub_ch_list[{i}]&quot;)</span>
            <span class="c1"># print(&quot;ch_model:&quot;, sub_ch.ch_model)</span>
            <span class="c1"># print(&quot;ssa:&quot;, sub_ch.ch_model.ssa)</span>

            <span class="n">var_prop2ct_prop</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">var_prop</span><span class="p">,</span> <span class="n">ct_prop</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">sub_ch</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">input_prop</span><span class="p">,</span>
                                         <span class="bp">self</span><span class="o">.</span><span class="n">input_prop</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">sub_ch_list</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">output_prop</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">ct_prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var_prop2ct_prop</span>
                <span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="n">var_prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_prop</span>

            <span class="c1"># print(&quot;var_prop2ct_prop (+ input_prop):&quot;, var_prop2ct_prop)</span>

            <span class="c1"># ChModel.split ensures external props are the same</span>
            <span class="k">for</span> <span class="n">var</span><span class="p">,</span> <span class="n">ct_prop</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_props</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">sub_ch</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="n">ct_prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var_prop2ct_prop</span>
                    <span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">)(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ct_prop</span>

            <span class="c1"># print(&quot;var_prop2ct_prop (+ external_props):&quot;, var_prop2ct_prop)</span>

            <span class="n">found_invalid_om</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">var_out_prop</span><span class="p">,</span> <span class="n">new_om</span> <span class="ow">in</span> <span class="n">sub_ch</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">assign_outprop2op_model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">new_om</span><span class="p">,</span> <span class="n">cascada_opmodel</span><span class="o">.</span><span class="n">ModelIdentity</span><span class="p">):</span>
                    <span class="n">ct_in_prop</span> <span class="o">=</span> <span class="n">new_om</span><span class="o">.</span><span class="n">input_prop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="n">var_prop2ct_prop</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ct_in_prop</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="n">var_prop2ct_prop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var_out_prop</span><span class="p">,</span> <span class="n">ct_in_prop</span><span class="p">)</span> <span class="o">==</span> <span class="n">ct_in_prop</span>
                    <span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="n">var_out_prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_in_prop</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ct_out_prop</span><span class="p">,</span> <span class="n">ct_old_om</span> <span class="o">=</span> <span class="n">old_om2ct_op_om</span><span class="p">[</span><span class="n">new_om2old_om</span><span class="p">[</span><span class="n">new_om</span><span class="p">]]</span>

                    <span class="n">index_assign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuple_assign_outprop2op_model</span><span class="o">.</span><span class="n">index</span><span class="p">((</span><span class="n">ct_out_prop</span><span class="p">,</span> <span class="n">ct_old_om</span><span class="p">))</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment_weights</span><span class="p">[</span><span class="n">index_assign</span><span class="p">]</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                        <span class="n">found_invalid_om</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="k">for</span> <span class="n">var_in_prop</span><span class="p">,</span> <span class="n">ct_in_prop</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">new_om</span><span class="o">.</span><span class="n">input_prop</span><span class="p">,</span> <span class="n">ct_old_om</span><span class="o">.</span><span class="n">input_prop</span><span class="p">):</span>
                        <span class="n">var_in_prop</span> <span class="o">=</span> <span class="n">var_in_prop</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="n">var_prop2ct_prop</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_in_prop</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">):</span>
                            <span class="k">continue</span>
                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">var_in_prop</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Variable</span><span class="p">)</span>
                        <span class="k">assert</span> <span class="n">var_prop2ct_prop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var_in_prop</span><span class="p">,</span> <span class="n">ct_in_prop</span><span class="p">)</span> <span class="o">==</span> <span class="n">ct_in_prop</span>
                        <span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="n">var_in_prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_in_prop</span>

                    <span class="k">assert</span> <span class="n">var_prop2ct_prop</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">var_out_prop</span><span class="p">,</span> <span class="n">ct_out_prop</span><span class="p">)</span> <span class="o">==</span> <span class="n">ct_out_prop</span>
                    <span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="n">var_out_prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_out_prop</span>

            <span class="c1"># print(&quot;var_prop2ct_prop (+ assignment):&quot;, var_prop2ct_prop)</span>

            <span class="n">var2ct</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span>
                <span class="p">[(</span><span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">ct_prop</span><span class="o">.</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">var_prop</span><span class="p">,</span> <span class="n">ct_prop</span> <span class="ow">in</span> <span class="n">var_prop2ct_prop</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="p">)</span>
            <span class="n">init_props</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">get_properties_for_initialization</span><span class="p">(</span><span class="n">sub_ch</span><span class="o">.</span><span class="n">ch_model</span><span class="p">,</span> <span class="n">var2ct</span><span class="p">)</span>
            <span class="n">sub_ch</span><span class="o">.</span><span class="n">input_prop</span><span class="p">,</span> <span class="n">sub_ch</span><span class="o">.</span><span class="n">output_prop</span><span class="p">,</span> \
            <span class="n">sub_ch</span><span class="o">.</span><span class="n">external_props</span><span class="p">,</span> <span class="n">sub_ch</span><span class="o">.</span><span class="n">assign_outprop_list</span> <span class="o">=</span> <span class="n">init_props</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_ch_list</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">sub_ch</span><span class="o">.</span><span class="n">output_prop</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_prop</span>

            <span class="c1"># print(&quot;sub_ch (SubCh):&quot;, sub_ch_list[i])</span>

            <span class="c1"># ensuring sub_ch_list[i] is an instance of Ch and not of EncCh</span>
            <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span> <span class="n">EncryptionCharacteristic</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">ch_cls</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">ch_cls</span><span class="p">,</span> <span class="n">EncryptionCharacteristic</span><span class="p">):</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Characteristic not in parents of </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="si">}</span><span class="s2"> = &quot;</span>
                                     <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__bases__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ch_cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>

            <span class="n">sub_ch_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch_cls</span><span class="o">.</span><span class="n">_prop_new</span><span class="p">(</span>
                <span class="n">input_prop</span><span class="o">=</span><span class="n">sub_ch</span><span class="o">.</span><span class="n">input_prop</span><span class="p">,</span>
                <span class="n">output_prop</span><span class="o">=</span><span class="n">sub_ch</span><span class="o">.</span><span class="n">output_prop</span><span class="p">,</span>
                <span class="n">assign_outprop_list</span><span class="o">=</span><span class="n">sub_ch</span><span class="o">.</span><span class="n">assign_outprop_list</span><span class="p">,</span>
                <span class="n">ch_model</span><span class="o">=</span><span class="n">sub_ch</span><span class="o">.</span><span class="n">ch_model</span><span class="p">,</span>
                <span class="n">external_props</span><span class="o">=</span><span class="n">sub_ch</span><span class="o">.</span><span class="n">external_props</span><span class="p">,</span>
                <span class="n">free_props</span><span class="o">=</span><span class="n">sub_ch</span><span class="o">.</span><span class="n">free_props</span><span class="p">,</span>
                <span class="n">empirical_ch_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">empirical_data_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">is_valid</span><span class="o">=</span><span class="ow">not</span> <span class="n">found_invalid_om</span>
            <span class="p">)</span>

            <span class="c1"># print(&quot;sub_ch (Characteristic):&quot;, sub_ch_list[i])</span>

            <span class="n">aux_free_props</span> <span class="o">|=</span> <span class="nb">set</span><span class="p">(</span><span class="n">sub_ch_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">free_props</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">aux_free_props</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">free_props</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">sub_ch_list</span></div>

    <span class="k">def</span> <span class="nf">_get_empirical_ch_weights_C</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_input_samples</span><span class="p">,</span> <span class="n">num_external_samples</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">num_parallel_processes</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of empirical weights (one for each ``num_external_samples``)</span>
<span class="sd">        by compiling and executing C code.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;subclasses must override this method&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_empirical_ch_weights_Python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_input_samples</span><span class="p">,</span> <span class="n">num_external_samples</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a list of empirical weights (one for each ``num_external_samples``).&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;subclasses must override this method&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_empirical_data_complexity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_input_samples</span><span class="p">,</span> <span class="n">num_external_samples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return num_input_samples and num_external_samples depending on the weight.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;subclasses must override this method&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Characteristic.compute_empirical_ch_weight"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.Characteristic.compute_empirical_ch_weight">[docs]</a>    <span class="k">def</span> <span class="nf">compute_empirical_ch_weight</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_input_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">num_external_samples</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">split_by_max_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">split_by_rounds</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                    <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">C_code</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">num_parallel_processes</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute and store the empirical weight.</span>

<span class="sd">        Given the characteristic</span>
<span class="sd">        :math:`(\Delta_{x_0} \mapsto \Delta_{x_1} \mapsto \dots \mapsto \Delta_{x_r})`</span>
<span class="sd">        over :math:`f`,</span>
<span class="sd">        the empirical weight is an estimation of the propagation weight</span>
<span class="sd">        of :math:`(\Delta_{x_0}, \Delta_{x_r})` empirically obtained by evaluating</span>
<span class="sd">        :math:`f` for many sampled inputs and external samples</span>
<span class="sd">        (if :math:`f` has external variables).</span>

<span class="sd">        .. note::</span>

<span class="sd">            The empirical weight only takes into account</span>
<span class="sd">            the input and output properties;</span>
<span class="sd">            intermediate properties in the trail are ignored.</span>

<span class="sd">            Note it is possible for the empirical weight to be smaller</span>
<span class="sd">            than `ch_weight` in some cases and to be larger in others.</span>

<span class="sd">        If :math:`f` does not have external variables,</span>
<span class="sd">        in general (depends on  the `Property`)</span>
<span class="sd">        the empirical weight is computed by :math:`f`-evaluating</span>
<span class="sd">        ``num_input_samples`` random inputs satisfying `input_prop`</span>
<span class="sd">        and counting the number of outputs satisfying `output_prop`.</span>
<span class="sd">        This procedure is called here the basic subroutine, and it varies</span>
<span class="sd">        from `Property` to `Property`.</span>

<span class="sd">        If :math:`f` contains external variables,</span>
<span class="sd">        the basic subroutine is repeated</span>
<span class="sd">        ``num_external_samples`` times, where the external variables</span>
<span class="sd">        are fixed in each iteration to random values satisfying `external_props`.</span>
<span class="sd">        As a result, ``num_external_samples`` auxiliary empirical weights are</span>
<span class="sd">        obtained, and the final empirical weight is taken as</span>
<span class="sd">        the negative binary logarithm of the average of the underlying</span>
<span class="sd">        probabilities of the auxiliary empirical weights.</span>

<span class="sd">        .. note::</span>

<span class="sd">            The average is taken on the underlying probabilities since</span>
<span class="sd">            these probabilities might be zero in some cases</span>
<span class="sd">            (and their corresponding weights `math.inf`).</span>

<span class="sd">        This method computes the empirical weight and stores it</span>
<span class="sd">        in `empirical_ch_weight`. Moreover, the input parameters</span>
<span class="sd">        and the auxiliary weights is stored in</span>
<span class="sd">        `empirical_data_list` as a list of `EmpiricalWeightData` objects.</span>
<span class="sd">        This list contains multiple objects only if the characteristic</span>
<span class="sd">        was split into multiple ones (see below); in that case, this list</span>
<span class="sd">        contains an `EmpiricalWeightData` object for each characteristic</span>
<span class="sd">        the main one was split into.</span>

<span class="sd">        If one of the arguments ``split_by_max_weight`` or ``split_by_rounds``</span>
<span class="sd">        is enabled, the characteristic is first `split` into multiple characteristics</span>
<span class="sd">        and then the empirical weights of the new characteristics are computed</span>
<span class="sd">        (by calling `compute_empirical_ch_weight` on each new characteristic).</span>
<span class="sd">        The final empirical weight is taken as the sum of</span>
<span class="sd">        the empirical weights of the new characteristics.</span>
<span class="sd">        If the empirical weight of one of the new characteristics is</span>
<span class="sd">        `math.inf`, the ongoing computations are aborted and the unfinished</span>
<span class="sd">        empirical weights are stored as `EmpiricalWeightData` objects</span>
<span class="sd">        with ``math.inf`` weight, ``num_input_samples=0`` and</span>
<span class="sd">        ``num_external_samples=0``.</span>

<span class="sd">        .. note::</span>

<span class="sd">            When the characteristic is split, the final empirical weight is more</span>
<span class="sd">            an approximation of the characteristic weight that the weight of</span>
<span class="sd">            the input-output pair, as now the empirical weight computation</span>
<span class="sd">            also takes into account the intermediate properties</span>
<span class="sd">            that are part of the input and output properties of the new</span>
<span class="sd">            characteristics are also taken into account.</span>

<span class="sd">        Args:</span>
<span class="sd">            num_input_samples: the number of inputs to sample.</span>
<span class="sd">            num_external_samples: the number of external samples</span>
<span class="sd">                (set to 0 if the underlying bit-vector function does not</span>
<span class="sd">                contain external variables).</span>
<span class="sd">            split_by_max_weight: an optional number; if given, computes</span>
<span class="sd">                the empirical weight by splitting the characteristic</span>
<span class="sd">                into multiple characteristics (each one with maximum</span>
<span class="sd">                weight less than</span>
<span class="sd">                ``max(split_by_max_weight, max(self.assignment_weights))``</span>
<span class="sd">                ).</span>
<span class="sd">            split_by_rounds: if ``True``, computes the empirical weight</span>
<span class="sd">                by splitting the characteristic into multiple</span>
<span class="sd">                characteristics, each one covering one round (only available</span>
<span class="sd">                if the underlying function of the characteristic model is</span>
<span class="sd">                a `RoundBasedFunction` including `add_round_outputs` calls</span>
<span class="sd">                in its ``eval``)</span>
<span class="sd">            seed: the seed for sampling random bit-vectors</span>
<span class="sd">            C_code: whether to use a faster C implementation generated on-the-fly</span>
<span class="sd">            num_parallel_processes: if not ``None`` and ``C_code=True``,</span>
<span class="sd">                the auxiliary empirical weights are computed in parallel</span>
<span class="sd">                (using the given number of worker processes)</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">num_parallel_processes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">C_code</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_parallel_processes is only supported for C_code=True&quot;</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">num_parallel_processes</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">num_parallel_processes</span>

        <span class="k">if</span> <span class="n">C_code</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">input_prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_prop</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">external_props</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">prop</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;disabling C_code and num_parallel_processes as &quot;</span>
                                  <span class="s2">&quot;bit-vector with more than 64 bits found&quot;</span><span class="p">)</span>
                    <span class="n">C_code</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">num_parallel_processes</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">break</span>

        <span class="k">if</span> <span class="n">num_input_samples</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span> <span class="o">==</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_input_samples must be provided if ch_weight == math.inf&quot;</span><span class="p">)</span>

        <span class="n">prop_separators</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">split_by_max_weight</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">split_by_max_weight</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_weight</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">split_by_max_weight</span> <span class="o">&lt;</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_weights</span><span class="p">):</span>
                <span class="n">split_by_max_weight</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_weights</span><span class="p">)</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;setting split_by_max_weight to max(assignment_weights)=</span><span class="si">{</span><span class="n">split_by_max_weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">prop_separators</span> <span class="o">=</span> <span class="p">[[]]</span>
            <span class="n">max_subch_weigh</span> <span class="o">=</span> <span class="n">split_by_max_weight</span>
            <span class="n">sum_aw</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">aw</span><span class="p">,</span> <span class="n">outprop</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignment_weights</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">assign_outprop2op_model</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">sum_aw</span> <span class="o">+</span> <span class="n">aw</span> <span class="o">&lt;=</span> <span class="n">max_subch_weigh</span><span class="p">:</span>  <span class="c1"># or len(prop_separators[-1]) == 0</span>
                    <span class="n">sum_aw</span> <span class="o">+=</span> <span class="n">aw</span>
                    <span class="n">prop_separators</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">outprop</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">prop_separators</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="n">sum_aw</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">prop_separators</span><span class="o">.</span><span class="n">append</span><span class="p">([])</span>
            <span class="c1"># remove last item so that the new last item is a separator</span>
            <span class="c1"># (and not a terminator) between the 2nd-to-last round and the last round</span>
            <span class="k">del</span> <span class="n">prop_separators</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">prop_separators</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">ds</span><span class="p">)</span> <span class="k">for</span> <span class="n">ds</span> <span class="ow">in</span> <span class="n">prop_separators</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">split_by_rounds</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">cascada_ssa</span><span class="o">.</span><span class="n">RoundBasedFunction</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;the underlying function of the characteristic &quot;</span>
                                 <span class="s2">&quot;model is not a RoundBasedFunction&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">_rounds_outputs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">_rounds_outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;the underlying function of the characteristic &quot;</span>
                                 <span class="s2">&quot;model does not include add_round_outputs calls&quot;</span><span class="p">)</span>
            <span class="n">prop_separators</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_round_separators</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">prop_separators</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">prop_separators</span> <span class="o">!=</span> <span class="p">(((),))</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">prop_separators</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">sub_ch_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">prop_separators</span><span class="p">)</span>

            <span class="n">total_ew</span> <span class="o">=</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">sub_ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sub_ch_list</span><span class="p">):</span>
                <span class="n">sub_ch</span><span class="o">.</span><span class="n">compute_empirical_ch_weight</span><span class="p">(</span>
                    <span class="n">num_input_samples</span><span class="o">=</span><span class="n">num_input_samples</span><span class="p">,</span>
                    <span class="n">num_external_samples</span><span class="o">=</span><span class="n">num_external_samples</span><span class="p">,</span>
                    <span class="n">C_code</span><span class="o">=</span><span class="n">C_code</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_ch</span><span class="o">.</span><span class="n">empirical_data_list</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>

                <span class="k">if</span> <span class="n">sub_ch</span><span class="o">.</span><span class="n">empirical_ch_weight</span> <span class="o">!=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">:</span>
                    <span class="n">total_ew</span> <span class="o">+=</span> <span class="n">sub_ch</span><span class="o">.</span><span class="n">empirical_ch_weight</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">total_ew</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sub_ch_list</span><span class="p">)):</span>
                        <span class="n">sub_ch_list</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">empirical_data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">EmpiricalWeightData</span><span class="p">(</span>
                            <span class="n">aux_weights</span><span class="o">=</span><span class="p">[</span><span class="n">math</span><span class="o">.</span><span class="n">inf</span><span class="p">],</span> <span class="n">num_input_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                            <span class="n">num_external_samples</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">C_code</span><span class="o">=</span><span class="n">C_code</span><span class="p">)]</span>
                    <span class="k">break</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">empirical_ch_weight</span> <span class="o">=</span> <span class="n">total_ew</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">empirical_data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">sub_ch</span><span class="o">.</span><span class="n">empirical_data_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">sub_ch</span> <span class="ow">in</span> <span class="n">sub_ch_list</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">num_input_samples</span><span class="p">,</span> <span class="n">num_external_samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_empirical_data_complexity</span><span class="p">(</span>
                <span class="n">num_input_samples</span><span class="p">,</span> <span class="n">num_external_samples</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">C_code</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">num_input_samples</span> <span class="o">*</span> <span class="n">num_external_samples</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">30</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;calling compute_empirical_ch_weight() with more than 2**30 samples &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;(</span><span class="si">{</span><span class="n">num_input_samples</span> <span class="o">*</span> <span class="n">num_external_samples</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">ew_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_empirical_ch_weights_C</span><span class="p">(</span><span class="n">num_input_samples</span><span class="p">,</span> <span class="n">num_external_samples</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">num_parallel_processes</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">num_input_samples</span> <span class="o">*</span> <span class="n">num_external_samples</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="o">**</span><span class="mi">20</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;calling compute_empirical_ch_weight() with C_code=False and with more than &quot;</span>
                                  <span class="sa">f</span><span class="s2">&quot;2**20 samples (</span><span class="si">{</span><span class="n">num_input_samples</span> <span class="o">*</span> <span class="n">num_external_samples</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
                <span class="n">ew_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_empirical_ch_weights_Python</span><span class="p">(</span><span class="n">num_input_samples</span><span class="p">,</span> <span class="n">num_external_samples</span><span class="p">,</span> <span class="n">seed</span><span class="p">)</span>

            <span class="n">data</span> <span class="o">=</span> <span class="n">EmpiricalWeightData</span><span class="p">(</span>
                <span class="n">aux_weights</span><span class="o">=</span><span class="n">ew_list</span><span class="p">,</span> <span class="n">num_input_samples</span><span class="o">=</span><span class="n">num_input_samples</span><span class="p">,</span>
                <span class="n">num_external_samples</span><span class="o">=</span><span class="n">num_external_samples</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">C_code</span><span class="o">=</span><span class="n">C_code</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">empirical_ch_weight</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">weight_avg_aux_prs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">empirical_data_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">data</span><span class="p">]</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_sample_bv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">myPRNG</span><span class="p">,</span> <span class="n">width</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="n">myPRNG</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">width</span><span class="p">),</span> <span class="n">width</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_sample_outprop_opmodel</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">prop_type</span><span class="p">,</span> <span class="n">ct_op_model</span><span class="p">,</span> <span class="n">outprop_width</span><span class="p">,</span> <span class="n">get_random_bv</span><span class="p">):</span>
        <span class="n">zero_one_set</span> <span class="o">=</span> <span class="p">{</span><span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)}</span>
        <span class="k">with</span> <span class="n">context</span><span class="o">.</span><span class="n">Simplification</span><span class="p">(</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="nb">min</span><span class="p">(</span><span class="n">outprop_width</span><span class="p">,</span> <span class="mi">16</span><span class="p">)):</span>
                <span class="n">ct_prop</span> <span class="o">=</span> <span class="n">prop_type</span><span class="p">(</span><span class="n">get_random_bv</span><span class="p">(</span><span class="n">outprop_width</span><span class="p">))</span>
                <span class="n">validity</span> <span class="o">=</span> <span class="n">ct_op_model</span><span class="o">.</span><span class="n">validity_constraint</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">validity</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">zero_one_set</span><span class="p">:</span>
                    <span class="n">evs</span> <span class="o">=</span> <span class="n">ct_op_model</span><span class="o">.</span><span class="n">external_vars_validity_constraint</span><span class="p">(</span><span class="n">ct_prop</span><span class="p">)</span>
                    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">evs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="n">validity</span> <span class="o">=</span> <span class="n">validity</span><span class="o">.</span><span class="n">xreplace</span><span class="p">({</span><span class="n">v</span><span class="p">:</span> <span class="n">get_random_bv</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">width</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">evs</span><span class="p">})</span>
                    <span class="k">assert</span> <span class="n">validity</span> <span class="ow">in</span> <span class="n">zero_one_set</span>
                <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">validity</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">ct_prop</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_sample_var2ct</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ch_model</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">external_props</span><span class="p">):</span>
        <span class="c1"># external_props needed for CipherCharacteristic</span>
        <span class="n">PRNG</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">Random</span><span class="p">()</span>
        <span class="n">PRNG</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">MAX_TRIES_PER_OM</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
            <span class="n">ch_model</span><span class="o">.</span><span class="n">input_prop</span><span class="p">,</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">assign_outprop2op_model</span>
        <span class="p">))),</span> <span class="mi">2</span><span class="o">**</span><span class="mi">16</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">get_random_bv</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sample_bv</span><span class="p">(</span><span class="n">PRNG</span><span class="p">,</span> <span class="n">width</span><span class="p">)</span>

        <span class="c1"># print(&quot;# Computing get_random_characteristic&quot;)</span>
        <span class="c1"># print(&quot;ch_model:&quot;, ch_model)</span>
        <span class="c1"># print()</span>

        <span class="n">index_try</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">index_try</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">index_try</span> <span class="o">==</span> <span class="n">MAX_TRIES_PER_OM</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no random characteristic found in </span><span class="si">{</span><span class="n">MAX_TRIES_PER_OM</span><span class="si">}</span><span class="s2"> tries for </span><span class="si">{</span><span class="n">ch_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">var_prop2ct_prop</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
            <span class="c1"># input_prop = []</span>
            <span class="k">for</span> <span class="n">var_prop</span> <span class="ow">in</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">input_prop</span><span class="p">:</span>
                <span class="n">ct_prop</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">var_prop</span><span class="p">)(</span><span class="n">get_random_bv</span><span class="p">(</span><span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
                <span class="c1"># input_prop.append(ct_prop)</span>
                <span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="n">var_prop</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_prop</span>

            <span class="c1"># print(&quot;var_prop2ct_prop (+ input_prop):&quot;, var_prop2ct_prop)</span>

            <span class="k">if</span> <span class="n">external_props</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">external_props</span><span class="p">)</span>
                <span class="n">external_props</span> <span class="o">=</span> <span class="n">external_props</span><span class="p">[:]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">external_props</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">external_props</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="p">),</span> \
                <span class="sa">f</span><span class="s2">&quot;len(</span><span class="si">{</span><span class="n">external_props</span><span class="si">}</span><span class="s2">) == len(</span><span class="si">{</span><span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="p">):</span>
                <span class="n">model_prop</span> <span class="o">=</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model_prop</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">):</span>
                    <span class="k">assert</span> <span class="n">external_props</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">model_prop</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">external_props</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">):</span>
                    <span class="n">external_props</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">get_random_bv</span><span class="p">(</span><span class="n">model_prop</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span><span class="p">))</span>
                <span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">var</span><span class="p">)]</span> <span class="o">=</span> <span class="n">external_props</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="c1"># print(&quot;var_prop2ct_prop (+ external_props):&quot;, var_prop2ct_prop)</span>

            <span class="c1"># assign_outprop_list = []</span>
            <span class="n">found_invalid_opmodel</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">outprop</span><span class="p">,</span> <span class="n">om</span> <span class="ow">in</span> <span class="n">ch_model</span><span class="o">.</span><span class="n">assign_outprop2op_model</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">om</span><span class="p">,</span> <span class="n">cascada_opmodel</span><span class="o">.</span><span class="n">ModelIdentity</span><span class="p">):</span>
                    <span class="n">ct_prop</span> <span class="o">=</span> <span class="n">om</span><span class="o">.</span><span class="n">input_prop</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="n">var_prop2ct_prop</span><span class="p">)</span>
                    <span class="c1"># assign_outprop_list.append(ct_prop)</span>
                    <span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="n">outprop</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_prop</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ct_om</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">om</span><span class="p">)([</span><span class="n">d</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="n">var_prop2ct_prop</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">om</span><span class="o">.</span><span class="n">input_prop</span><span class="p">])</span>
                    <span class="n">ct_prop</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sample_outprop_opmodel</span><span class="p">(</span>
                        <span class="nb">type</span><span class="p">(</span><span class="n">outprop</span><span class="p">),</span> <span class="n">ct_om</span><span class="p">,</span> <span class="n">outprop</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">get_random_bv</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">ct_prop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">found_invalid_opmodel</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                    <span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="n">outprop</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct_prop</span>
                <span class="k">if</span> <span class="n">found_invalid_opmodel</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">found_invalid_opmodel</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="c1"># print(&quot;var_prop2ct_prop (+ assignment):&quot;, var_prop2ct_prop)</span>

        <span class="n">var2ct</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">(</span>
            <span class="p">[(</span><span class="n">var_prop</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">ct_prop</span><span class="o">.</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">var_prop</span><span class="p">,</span> <span class="n">ct_prop</span> <span class="ow">in</span> <span class="n">var_prop2ct_prop</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">var2ct</span>

<div class="viewcode-block" id="Characteristic.random"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.Characteristic.random">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ch_model</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">external_props</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a random `Characteristic` with given `abstractproperty.chmodel.ChModel`.</span>

<span class="sd">        Args:</span>
<span class="sd">            ch_model: the underlying characteristic model</span>
<span class="sd">            seed: the seed used to sample bit-vectors</span>
<span class="sd">            external_props: a list containing the (constant) `Property` of</span>
<span class="sd">                the external variables or ``None`` to sample random properties</span>
<span class="sd">                for the external variables.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch_model</span><span class="p">,</span> <span class="n">cascada_chmodel</span><span class="o">.</span><span class="n">ChModel</span><span class="p">)</span>

        <span class="n">var2ct</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sample_var2ct</span><span class="p">(</span><span class="n">ch_model</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">external_props</span><span class="p">)</span>

        <span class="n">init_props</span> <span class="o">=</span> <span class="n">Characteristic</span><span class="o">.</span><span class="n">get_properties_for_initialization</span><span class="p">(</span><span class="n">ch_model</span><span class="p">,</span> <span class="n">var2ct</span><span class="p">)</span>
        <span class="n">input_prop</span><span class="p">,</span> <span class="n">output_prop</span><span class="p">,</span> <span class="n">external_props</span><span class="p">,</span> <span class="n">assign_outprop_list</span> <span class="o">=</span> <span class="n">init_props</span>

        <span class="n">ch</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_prop_new</span><span class="p">(</span>
            <span class="n">input_prop</span><span class="o">=</span><span class="n">input_prop</span><span class="p">,</span> <span class="n">output_prop</span><span class="o">=</span><span class="n">output_prop</span><span class="p">,</span> <span class="n">assign_outprop_list</span><span class="o">=</span><span class="n">assign_outprop_list</span><span class="p">,</span>
            <span class="n">ch_model</span><span class="o">=</span><span class="n">ch_model</span><span class="p">,</span> <span class="n">external_props</span><span class="o">=</span><span class="n">external_props</span><span class="p">,</span> <span class="n">free_props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">empirical_ch_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">empirical_data_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ch</span></div>

<div class="viewcode-block" id="Characteristic.get_formatted_logged_msgs"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.Characteristic.get_formatted_logged_msgs">[docs]</a>    <span class="k">def</span> <span class="nf">get_formatted_logged_msgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of logged messages.</span>

<span class="sd">        If ``self.ch_model.func`` includes `log_msg` calls in its ``eval``,</span>
<span class="sd">        this method return the list of messages logged with the format field</span>
<span class="sd">        objects applied. Otherwise, an empty list is returned.</span>

<span class="sd">        In the first case, the `Variable` objects of ``self.ch_model.ssa``</span>
<span class="sd">        appearing in the format field objects are replaced with their</span>
<span class="sd">        associated constant  `Property` objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">_logger</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">list_msgs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">replacements</span> <span class="o">=</span> <span class="p">{</span><span class="n">vp</span><span class="o">.</span><span class="n">val</span><span class="p">:</span> <span class="n">cp</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">vp</span><span class="p">,</span> <span class="n">cp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">var_prop2ct_prop</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">format_string</span><span class="p">,</span> <span class="n">format_field_objects</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">_logger</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">format_field_objects</span><span class="p">)):</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">format_field_objects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Term</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">):</span>
                    <span class="n">format_field_objects</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="n">replacements</span><span class="p">))</span>
            <span class="n">list_msgs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">format_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">format_field_objects</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">list_msgs</span></div>

<div class="viewcode-block" id="Characteristic.get_round_separators"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.Characteristic.get_round_separators">[docs]</a>    <span class="k">def</span> <span class="nf">get_round_separators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the round separators if ``self.ch_model.func`` is a `RoundBasedFunction`.</span>

<span class="sd">        If ``self.ch_model.func`` includes `add_round_outputs` calls in its ``eval``,</span>
<span class="sd">        this method returns a list with the (symbolic) round `Property`</span>
<span class="sd">        outputs delimiting the rounds. Otherwise, ``None`` is returned.</span>

<span class="sd">        In the first case, this list contains ``num_rounds - 1`` entries,</span>
<span class="sd">        where the ``i``-th entry is the list of (symbolic) `Property`</span>
<span class="sd">        outputs of the ``i``-th round. In particular, the output properties</span>
<span class="sd">        of the last round are not included in this list.</span>

<span class="sd">        The list returned by this method is meant to be used as the argument</span>
<span class="sd">        of `Characteristic.split` to get the `Characteristic` object of each round.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="p">,</span> <span class="s2">&quot;_rounds_outputs&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">_rounds_outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">lv</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">lv</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">_rounds_outputs</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>

    <span class="c1"># dotprinting last method</span>
<div class="viewcode-block" id="Characteristic.dotprinting"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.Characteristic.dotprinting">[docs]</a>    <span class="k">def</span> <span class="nf">dotprinting</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vrepr_label</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the DOT description of the expression tree of `tuple_assign_outprop2op_model`.</span>

<span class="sd">        See also `printing.dotprinting`.</span>

<span class="sd">        Args:</span>
<span class="sd">            repeat: whether to use different nodes for common subexpressions</span>
<span class="sd">                (default True)</span>
<span class="sd">            vrepr_label: whether to use the verbose representation (`Term.vrepr`)</span>
<span class="sd">                to label the nodes (default False)</span>
<span class="sd">            kwargs: additional arguments passed to `printing.dotprinting`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># similar as ChModel.dotprinting</span>
        <span class="kn">from</span> <span class="nn">cascada.bitvector.printing</span> <span class="kn">import</span> <span class="n">dotprinting</span>
        <span class="kn">from</span> <span class="nn">sympy.core.containers</span> <span class="kn">import</span> <span class="n">Tuple</span>
        <span class="kn">from</span> <span class="nn">sympy.core.basic</span> <span class="kn">import</span> <span class="n">Basic</span>
        <span class="c1"># sympy_property = type(self.prop_type.__name__, (Basic,), {})</span>
        <span class="n">op_model_class2sympy_op_model</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">out_prop</span><span class="p">,</span> <span class="n">op_model</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tuple_assign_outprop2op_model</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">op_model</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">op_model_class2sympy_op_model</span><span class="p">:</span>
                <span class="n">sympy_op_model</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">op_model</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="p">(</span><span class="n">Basic</span><span class="p">,),</span> <span class="p">{})</span>
                <span class="n">op_model_class2sympy_op_model</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">op_model</span><span class="p">)]</span> <span class="o">=</span> <span class="n">sympy_op_model</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sympy_op_model</span> <span class="o">=</span> <span class="n">op_model_class2sympy_op_model</span><span class="p">[</span><span class="nb">type</span><span class="p">(</span><span class="n">op_model</span><span class="p">)]</span>
            <span class="n">expr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Tuple</span><span class="p">(</span>
                <span class="c1"># sympy_property(out_prop.val),</span>
                <span class="n">out_prop</span><span class="o">.</span><span class="n">val</span><span class="p">,</span>
                <span class="c1"># sympy_op_model(Tuple(*[sympy_property(d.val) for d in op_model.input_prop]))</span>
                <span class="n">sympy_op_model</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">d</span><span class="o">.</span><span class="n">val</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">op_model</span><span class="o">.</span><span class="n">input_prop</span><span class="p">])</span>
            <span class="p">))</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">(</span><span class="o">*</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dotprinting</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="n">repeat</span><span class="p">,</span> <span class="n">vrepr_label</span><span class="o">=</span><span class="n">vrepr_label</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="EncryptionCharacteristic"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.EncryptionCharacteristic">[docs]</a><span class="k">class</span> <span class="nc">EncryptionCharacteristic</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent characteristics over encryption functions w.r.t some property.</span>

<span class="sd">    Given a `Cipher`, an `EncryptionCharacteristic` is a characteristic</span>
<span class="sd">    (see `Characteristic`) for a particular `Property` over</span>
<span class="sd">    the `Cipher.encryption` (where the `Cipher.key_schedule`</span>
<span class="sd">    is ignored).</span>

<span class="sd">    As opposed to `Characteristic`, an `EncryptionCharacteristic` is defined</span>
<span class="sd">    for a `abstractproperty.chmodel.EncryptionChModel`.</span>

<span class="sd">    This class is not meant to be instantiated but to provide a base</span>
<span class="sd">    class for creating characteristic over encryption functions,</span>
<span class="sd">    (see `differential.characteristic.EncryptionCharacteristic`,</span>
<span class="sd">    `linear.characteristic.EncryptionCharacteristic` or</span>
<span class="sd">    `algebraic.characteristic.EncryptionCharacteristic` for some examples).</span>

<span class="sd">    .. Implementation details:</span>

<span class="sd">        This class does not subclass `Characteristic`, but subclasses</span>
<span class="sd">        of this class defined for a particular `Property`</span>
<span class="sd">        must subclass the corresponding ``Characteristic``.</span>

<span class="sd">        Some subclasses might need to provide ``external_props``.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_prop</span><span class="p">,</span> <span class="n">output_prop</span><span class="p">,</span> <span class="n">assign_outprop_list</span><span class="p">,</span> <span class="n">ch_model</span><span class="p">,</span> <span class="n">external_props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">free_props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">empirical_ch_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">empirical_data_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch_model</span><span class="p">,</span> <span class="n">cascada_chmodel</span><span class="o">.</span><span class="n">EncryptionChModel</span><span class="p">)</span>
        <span class="c1"># ch_model instead of enc_ch_model as self has ch_model attribute</span>
        <span class="c1"># avoid external_props=external_props and free_props=free_props (super might not abstract)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">input_prop</span><span class="p">,</span> <span class="n">output_prop</span><span class="p">,</span> <span class="n">assign_outprop_list</span><span class="p">,</span> <span class="n">ch_model</span><span class="p">,</span> <span class="n">external_props</span><span class="p">,</span> <span class="n">free_props</span><span class="p">,</span>
            <span class="n">empirical_ch_weight</span><span class="o">=</span><span class="n">empirical_ch_weight</span><span class="p">,</span> <span class="n">empirical_data_list</span><span class="o">=</span><span class="n">empirical_data_list</span><span class="p">,</span> <span class="n">is_valid</span><span class="o">=</span><span class="n">is_valid</span><span class="p">)</span>

<div class="viewcode-block" id="EncryptionCharacteristic.split"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.EncryptionCharacteristic.split">[docs]</a>    <span class="k">def</span> <span class="nf">split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prop_separators</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Split into multiple `Characteristic` objects given the list of property separators.</span>

<span class="sd">        Given an `EncryptionCharacteristic`, this method calls `Characteristic.split` to</span>
<span class="sd">        split the characteristic.</span>

<span class="sd">        .. note::</span>

<span class="sd">            The new split characteristics are instances of `Characteristic`</span>
<span class="sd">            and not of `EncryptionCharacteristic`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">prop_separators</span><span class="p">)</span></div>

<div class="viewcode-block" id="EncryptionCharacteristic.random"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.EncryptionCharacteristic.random">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ch_model</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a random `EncryptionCharacteristic` with given `abstractproperty.chmodel.EncryptionChModel`.</span>

<span class="sd">        Args:</span>
<span class="sd">            ch_model: the underlying characteristic model of the encryption function</span>
<span class="sd">            seed: the seed used to sample bit-vectors</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ch_model</span><span class="p">,</span> <span class="n">cascada_chmodel</span><span class="o">.</span><span class="n">EncryptionChModel</span><span class="p">)</span>

        <span class="n">var2ct</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sample_var2ct</span><span class="p">(</span><span class="n">ch_model</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">init_props</span> <span class="o">=</span> <span class="n">Characteristic</span><span class="o">.</span><span class="n">get_properties_for_initialization</span><span class="p">(</span><span class="n">ch_model</span><span class="p">,</span> <span class="n">var2ct</span><span class="p">)</span>
        <span class="n">input_prop</span><span class="p">,</span> <span class="n">output_prop</span><span class="p">,</span> <span class="n">external_props</span><span class="p">,</span> <span class="n">assign_outprop_list</span> <span class="o">=</span> <span class="n">init_props</span>

        <span class="n">ch</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">input_prop</span><span class="p">,</span> <span class="n">output_prop</span><span class="p">,</span> <span class="n">assign_outprop_list</span><span class="p">,</span> <span class="n">ch_model</span><span class="p">,</span> <span class="n">external_props</span><span class="p">,</span>
            <span class="n">empirical_ch_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">empirical_data_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">is_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ch</span></div></div>


<div class="viewcode-block" id="CipherCharacteristic"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.CipherCharacteristic">[docs]</a><span class="k">class</span> <span class="nc">CipherCharacteristic</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent characteristics over ciphers w.r.t some property.</span>

<span class="sd">    A `CipherCharacteristic` is a pair of `Characteristic` objects</span>
<span class="sd">    where one covers the `Cipher.key_schedule`</span>
<span class="sd">    and the other one covers the `Cipher.encryption`.</span>

<span class="sd">    .. note::</span>

<span class="sd">        The characteristic over the `Cipher.encryption` is an instance of</span>
<span class="sd">        `Characteristic` and not an instance of `EncryptionCharacteristic`.</span>

<span class="sd">    The round key properties in the encryption characteristic</span>
<span class="sd">    (the properties of the external variables of the encryption `SSA`)</span>
<span class="sd">    are set to the output properties of the key-schedule characteristic.</span>

<span class="sd">    This class is not meant to be instantiated but to provide a base</span>
<span class="sd">    class for creating characteristic over ciphers,</span>
<span class="sd">    (see `differential.characteristic.CipherCharacteristic` or</span>
<span class="sd">    `algebraic.characteristic.CipherCharacteristic` for some examples).</span>

<span class="sd">    Attributes:</span>
<span class="sd">        cipher_ch_model: the underlying `abstractproperty.chmodel.CipherChModel`</span>
<span class="sd">        ks_characteristic: the `Characteristic` over the key schedule</span>
<span class="sd">        enc_characteristic: the `Characteristic` over the encryption function</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">_Characteristic_cls</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="CipherCharacteristic.get_properties_for_initialization"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.CipherCharacteristic.get_properties_for_initialization">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_properties_for_initialization</span><span class="p">(</span><span class="n">cipher_ch_model</span><span class="p">,</span> <span class="n">var2ct</span><span class="p">,</span> <span class="n">ks_free_props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enc_free_props</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the properties needed to initialize a `CipherCharacteristic` object.</span>

<span class="sd">        Given a `abstractproperty.chmodel.CipherChModel`</span>
<span class="sd">        and a dictionary mapping `Variable` objects</span>
<span class="sd">        (representing the symbolic properties) to their `Constant` values,</span>
<span class="sd">        this method returns the following objects:</span>
<span class="sd">        ``ks_input_prop``, ``ks_output_prop``, ``ks_assign_outprop_list``,</span>
<span class="sd">        ``enc_input_prop``, ``enc_output_prop`` and ``enc_assign_outprop_list``</span>
<span class="sd">        for the ``CipherCharacteristic.__init__`` method.</span>

<span class="sd">        Symbolic properties not affecting the characteristics can be</span>
<span class="sd">        given in ``ks_free_props`` and ``enc_free_props``,</span>
<span class="sd">        and they will be set to 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># var2ct and *_free compatibility are checked in Characteristic.get_properties_for_initialization</span>
        <span class="n">var2ct</span> <span class="o">=</span> <span class="n">var2ct</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">ks_init_props</span> <span class="o">=</span> <span class="n">Characteristic</span><span class="o">.</span><span class="n">get_properties_for_initialization</span><span class="p">(</span>
            <span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">ks_ch_model</span><span class="p">,</span> <span class="n">var2ct</span><span class="p">,</span> <span class="n">free_props</span><span class="o">=</span><span class="n">ks_free_props</span><span class="p">)</span>
        <span class="n">ks_input_prop</span><span class="p">,</span> <span class="n">ks_output_prop</span><span class="p">,</span> \
        <span class="n">ks_external_props</span><span class="p">,</span> <span class="n">ks_assign_outprop_list</span> <span class="o">=</span> <span class="n">ks_init_props</span>

        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">ks_external_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">enc_free_props</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">enc_free_props</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">enc_ch_model</span><span class="o">.</span><span class="n">external_var2prop</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">index_v</span> <span class="o">=</span> <span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">ks_ch_model</span><span class="o">.</span><span class="n">ssa</span><span class="o">.</span><span class="n">output_vars</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">ks_ch_model</span><span class="o">.</span><span class="n">output_prop</span><span class="p">[</span><span class="n">index_v</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">core</span><span class="o">.</span><span class="n">Constant</span><span class="p">):</span>
                <span class="k">assert</span> <span class="n">p</span><span class="o">.</span><span class="n">val</span> <span class="o">==</span> <span class="n">ks_output_prop</span><span class="p">[</span><span class="n">index_v</span><span class="p">]</span><span class="o">.</span><span class="n">val</span> <span class="o">==</span> <span class="n">var2ct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">val</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">v</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">var2ct</span> <span class="ow">and</span> <span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">prop_type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">enc_free_props</span><span class="p">:</span>
                    <span class="n">var2ct</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">ks_output_prop</span><span class="p">[</span><span class="n">index_v</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>

        <span class="n">enc_init_props</span> <span class="o">=</span> <span class="n">Characteristic</span><span class="o">.</span><span class="n">get_properties_for_initialization</span><span class="p">(</span>
            <span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">enc_ch_model</span><span class="p">,</span> <span class="n">var2ct</span><span class="p">,</span> <span class="n">free_props</span><span class="o">=</span><span class="n">enc_free_props</span><span class="p">)</span>
        <span class="n">enc_input_prop</span><span class="p">,</span> <span class="n">enc_output_prop</span><span class="p">,</span> \
        <span class="n">enc_external_props</span><span class="p">,</span> <span class="n">enc_assign_outprop_list</span> <span class="o">=</span> <span class="n">enc_init_props</span>

        <span class="k">return</span> <span class="n">ks_input_prop</span><span class="p">,</span> <span class="n">ks_output_prop</span><span class="p">,</span> <span class="n">ks_assign_outprop_list</span><span class="p">,</span> \
               <span class="n">enc_input_prop</span><span class="p">,</span> <span class="n">enc_output_prop</span><span class="p">,</span> <span class="n">enc_assign_outprop_list</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">ks_input_prop</span><span class="p">,</span> <span class="n">ks_output_prop</span><span class="p">,</span> <span class="n">ks_assign_outprop_list</span><span class="p">,</span>
            <span class="n">enc_input_prop</span><span class="p">,</span> <span class="n">enc_output_prop</span><span class="p">,</span> <span class="n">enc_assign_outprop_list</span><span class="p">,</span>
            <span class="n">cipher_ch_model</span><span class="p">,</span> <span class="n">ks_free_props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enc_free_props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ks_empirical_ch_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ks_empirical_data_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">enc_empirical_ch_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enc_empirical_data_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ks_is_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">enc_is_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cipher_ch_model</span><span class="p">,</span> <span class="n">cascada_chmodel</span><span class="o">.</span><span class="n">CipherChModel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cipher_ch_model</span> <span class="o">=</span> <span class="n">cipher_ch_model</span>

        <span class="c1"># ks_output_prop ordered as round_keys but enc_external_props ordered as ssa.external_vars</span>
        <span class="n">enc_external_props</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">enc_ch_model</span><span class="o">.</span><span class="n">ssa</span><span class="o">.</span><span class="n">external_vars</span><span class="p">:</span>
            <span class="n">index_v</span> <span class="o">=</span> <span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">ks_ch_model</span><span class="o">.</span><span class="n">ssa</span><span class="o">.</span><span class="n">output_vars</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">v</span> <span class="o">==</span> <span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">ks_ch_model</span><span class="o">.</span><span class="n">output_prop</span><span class="p">[</span><span class="n">index_v</span><span class="p">]</span><span class="o">.</span><span class="n">val</span>
            <span class="n">enc_external_props</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ks_output_prop</span><span class="p">[</span><span class="n">index_v</span><span class="p">])</span>

        <span class="n">myCharacteristic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="n">_Characteristic_cls</span>

        <span class="c1"># _prop_new to use free_props</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ks_characteristic</span> <span class="o">=</span> <span class="n">myCharacteristic</span><span class="o">.</span><span class="n">_prop_new</span><span class="p">(</span>
            <span class="n">ks_input_prop</span><span class="p">,</span> <span class="n">ks_output_prop</span><span class="p">,</span> <span class="n">ks_assign_outprop_list</span><span class="p">,</span>
            <span class="n">ch_model</span><span class="o">=</span><span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">ks_ch_model</span><span class="p">,</span> <span class="n">external_props</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">free_props</span><span class="o">=</span><span class="n">ks_free_props</span><span class="p">,</span>
            <span class="n">empirical_ch_weight</span><span class="o">=</span><span class="n">ks_empirical_ch_weight</span><span class="p">,</span> <span class="n">empirical_data_list</span><span class="o">=</span><span class="n">ks_empirical_data_list</span><span class="p">,</span> <span class="n">is_valid</span><span class="o">=</span><span class="n">ks_is_valid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">enc_characteristic</span> <span class="o">=</span> <span class="n">myCharacteristic</span><span class="o">.</span><span class="n">_prop_new</span><span class="p">(</span>
            <span class="n">enc_input_prop</span><span class="p">,</span> <span class="n">enc_output_prop</span><span class="p">,</span> <span class="n">enc_assign_outprop_list</span><span class="p">,</span>
            <span class="n">ch_model</span><span class="o">=</span><span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">enc_ch_model</span><span class="p">,</span> <span class="n">external_props</span><span class="o">=</span><span class="n">enc_external_props</span><span class="p">,</span> <span class="n">free_props</span><span class="o">=</span><span class="n">enc_free_props</span><span class="p">,</span>
            <span class="n">empirical_ch_weight</span><span class="o">=</span><span class="n">enc_empirical_ch_weight</span><span class="p">,</span> <span class="n">empirical_data_list</span><span class="o">=</span><span class="n">enc_empirical_data_list</span><span class="p">,</span> <span class="n">is_valid</span><span class="o">=</span><span class="n">enc_is_valid</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ks_characteristic</span><span class="o">.</span><span class="n">ch_model</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">ks_ch_model</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">enc_characteristic</span><span class="o">.</span><span class="n">ch_model</span><span class="p">)</span> <span class="o">==</span> <span class="nb">id</span><span class="p">(</span><span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">enc_ch_model</span><span class="p">)</span>

        <span class="n">aux_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_characteristic</span><span class="o">.</span><span class="n">var_prop2ct_prop</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">enc_characteristic</span><span class="o">.</span><span class="n">var_prop2ct_prop</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">aux_dict</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">ks_ch_model</span><span class="o">.</span><span class="n">output_prop</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_characteristic</span><span class="o">.</span><span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">==</span> \
                   <span class="bp">self</span><span class="o">.</span><span class="n">enc_characteristic</span><span class="o">.</span><span class="n">var_prop2ct_prop</span><span class="p">[</span><span class="n">v</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">(ks_characteristic=</span><span class="si">{}</span><span class="s2">, enc_characteristic=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ks_characteristic</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enc_characteristic</span><span class="o">.</span><span class="fm">__str__</span><span class="p">(),</span>
        <span class="p">)</span>

    <span class="fm">__repr__</span> <span class="o">=</span> <span class="fm">__str__</span>

<div class="viewcode-block" id="CipherCharacteristic.vrepr"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.CipherCharacteristic.vrepr">[docs]</a>    <span class="k">def</span> <span class="nf">vrepr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an executable string representation.</span>

<span class="sd">        This method returns a string so that ``eval(self.vrepr())``</span>
<span class="sd">        returns a new `CipherCharacteristic` object with the same content.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ks_ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_characteristic</span>
        <span class="n">enc_ch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">enc_characteristic</span>

        <span class="c1"># using v.val.vrepr() instead of v.vrepr() since __init__ allows Constant</span>
        <span class="c1"># or Difference(Constant) and the former is easier</span>

        <span class="k">if</span> <span class="n">ks_ch</span><span class="o">.</span><span class="n">free_props</span><span class="p">:</span>
            <span class="n">kfd_vrepr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ks_ch</span><span class="o">.</span><span class="n">free_props</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">if</span> <span class="n">enc_ch</span><span class="o">.</span><span class="n">free_props</span><span class="p">:</span>
            <span class="n">efd_vrepr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">enc_ch</span><span class="o">.</span><span class="n">free_props</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="k">if</span> <span class="n">ks_ch</span><span class="o">.</span><span class="n">empirical_data_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kedl_vrepr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ks_ch</span><span class="o">.</span><span class="n">empirical_data_list</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span>
        <span class="k">if</span> <span class="n">enc_ch</span><span class="o">.</span><span class="n">empirical_data_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">eedl_vrepr</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">e</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">enc_ch</span><span class="o">.</span><span class="n">empirical_data_list</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span>

        <span class="n">prop</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_characteristic</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">_prop_label</span>
        <span class="k">assert</span> <span class="n">prop</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">enc_characteristic</span><span class="o">.</span><span class="n">ch_model</span><span class="o">.</span><span class="n">_prop_label</span>

        <span class="n">format_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">{{}}</span><span class="s2">(ks_input_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">=</span><span class="se">{{}}</span><span class="s2">, ks_output_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">=</span><span class="se">{{}}</span><span class="s2">, ks_assign_out</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">_list=</span><span class="se">{{}}</span><span class="s2">, &quot;</span> \
                     <span class="sa">f</span><span class="s2">&quot;enc_input_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">=</span><span class="se">{{}}</span><span class="s2">, enc_output_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">=</span><span class="se">{{}}</span><span class="s2">, enc_assign_out</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">_list=</span><span class="se">{{}}</span><span class="s2">, &quot;</span> \
                     <span class="s2">&quot;cipher_ch_model=</span><span class="si">{}{}{}{}{}</span><span class="s2">)&quot;</span>
        <span class="k">return</span> <span class="n">format_str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ks_ch</span><span class="o">.</span><span class="n">input_prop</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ks_ch</span><span class="o">.</span><span class="n">output_prop</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ks_ch</span><span class="o">.</span><span class="n">tuple_assign_outprop2op_model</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">enc_ch</span><span class="o">.</span><span class="n">input_prop</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">enc_ch</span><span class="o">.</span><span class="n">output_prop</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;[</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">v</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">vrepr</span><span class="p">()</span> <span class="k">for</span> <span class="n">v</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">enc_ch</span><span class="o">.</span><span class="n">tuple_assign_outprop2op_model</span><span class="p">])</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">vrepr</span><span class="p">(),</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ks_ch</span><span class="o">.</span><span class="n">free_props</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, ks_free_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">s=</span><span class="si">{</span><span class="n">kfd_vrepr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">enc_ch</span><span class="o">.</span><span class="n">free_props</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, enc_free_</span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s2">s=</span><span class="si">{</span><span class="n">efd_vrepr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">ks_ch</span><span class="o">.</span><span class="n">empirical_ch_weight</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, ks_empirical_ch_weight=</span><span class="si">{</span><span class="n">ks_ch</span><span class="o">.</span><span class="n">empirical_ch_weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">ks_ch</span><span class="o">.</span><span class="n">empirical_data_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, ks_empirical_data_list=</span><span class="si">{</span><span class="n">kedl_vrepr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">enc_ch</span><span class="o">.</span><span class="n">empirical_ch_weight</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, enc_empirical_ch_weight=</span><span class="si">{</span><span class="n">enc_ch</span><span class="o">.</span><span class="n">empirical_ch_weight</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">enc_ch</span><span class="o">.</span><span class="n">empirical_data_list</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, enc_empirical_data_list=</span><span class="si">{</span><span class="n">eedl_vrepr</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">ks_ch</span><span class="o">.</span><span class="n">_is_valid</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, is_valid=</span><span class="si">{</span><span class="n">ks_ch</span><span class="o">.</span><span class="n">_is_valid</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="n">enc_ch</span><span class="o">.</span><span class="n">_is_valid</span> <span class="k">else</span> <span class="sa">f</span><span class="s2">&quot;, is_valid=</span><span class="si">{</span><span class="n">enc_ch</span><span class="o">.</span><span class="n">_is_valid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CipherCharacteristic.srepr"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.CipherCharacteristic.srepr">[docs]</a>    <span class="k">def</span> <span class="nf">srepr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a short string representation of the cipher characteristic.</span>

<span class="sd">        See also `Characteristic.srepr`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="s2">&quot;Ch(ks_ch=</span><span class="si">{}</span><span class="s2">, enc_ch=</span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ks_characteristic</span><span class="o">.</span><span class="n">srepr</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">enc_characteristic</span><span class="o">.</span><span class="n">srepr</span><span class="p">(),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="CipherCharacteristic.signature"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.CipherCharacteristic.signature">[docs]</a>    <span class="k">def</span> <span class="nf">signature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ch_signature_type</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the signature of the cipher characteristic.</span>

<span class="sd">        See also `Characteristic.signature`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_characteristic</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">ch_signature_type</span><span class="p">)</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">enc_characteristic</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">ch_signature_type</span><span class="p">)</span></div>

    <span class="c1"># def compute_empirical_ch_weight(self, num_input_samples=None, num_external_samples=None,</span>
    <span class="c1">#                                 split_by_max_weight=None, split_by_rounds=False,</span>
    <span class="c1">#                                 seed=None, C_code=False, num_parallel_processes=None):</span>
    <span class="c1">#     &quot;&quot;&quot;Compute and store the empirical weight.</span>
    <span class="c1">#</span>
    <span class="c1">#     Compute the empirical weight of the key schedule characteristic</span>
    <span class="c1">#     and the empirical weight of the encryption characteristic</span>
    <span class="c1">#     with two independent calls to `Characteristic.compute_empirical_ch_weight`.</span>
    <span class="c1">#</span>
    <span class="c1">#     The empirical weights and auxiliary data are stored in</span>
    <span class="c1">#     ``.empirical_ch_weight`` and ``.empirical_data_list`` of</span>
    <span class="c1">#     `ks_characteristic` and `enc_characteristic`.</span>
    <span class="c1">#</span>
    <span class="c1">#     See also `Characteristic.compute_empirical_ch_weight`.</span>
    <span class="c1">#     &quot;&quot;&quot;</span>
    <span class="c1">#     self.ks_characteristic.compute_empirical_ch_weight(</span>
    <span class="c1">#         num_input_samples=num_input_samples, num_external_samples=num_external_samples,</span>
    <span class="c1">#         split_by_max_weight=split_by_max_weight, split_by_rounds=split_by_rounds,</span>
    <span class="c1">#         C_code=C_code, num_parallel_processes=num_parallel_processes, seed=seed)</span>
    <span class="c1">#     self.enc_characteristic.compute_empirical_ch_weight(</span>
    <span class="c1">#         num_input_samples=num_input_samples, num_external_samples=num_external_samples,</span>
    <span class="c1">#         split_by_max_weight=split_by_max_weight, split_by_rounds=split_by_rounds,</span>
    <span class="c1">#         C_code=C_code, num_parallel_processes=num_parallel_processes, seed=seed)</span>

<div class="viewcode-block" id="CipherCharacteristic.random"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.CipherCharacteristic.random">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">random</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">cipher_ch_model</span><span class="p">,</span> <span class="n">seed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a random `CipherCharacteristic` with given `abstractproperty.chmodel.CipherChModel`.</span>

<span class="sd">        Args:</span>
<span class="sd">            cipher_ch_model: the underlying cipher characteristic model</span>
<span class="sd">            seed: the seed used to sample bit-vectors</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cipher_ch_model</span><span class="p">,</span> <span class="n">cascada_chmodel</span><span class="o">.</span><span class="n">CipherChModel</span><span class="p">)</span>
        <span class="n">myCharacteristic</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_Characteristic_cls</span>

        <span class="n">ks_var2ct</span> <span class="o">=</span> <span class="n">myCharacteristic</span><span class="o">.</span><span class="n">_sample_var2ct</span><span class="p">(</span>
            <span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">ks_ch_model</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">new_seed</span> <span class="o">=</span> <span class="nb">repr</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">ks_var2ct</span><span class="p">)</span>

        <span class="c1"># ks_output_prop ordered as round_keys but enc_external_props ordered as ssa.external_vars</span>
        <span class="n">pt</span> <span class="o">=</span> <span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">enc_ch_model</span><span class="o">.</span><span class="n">prop_type</span>
        <span class="n">enc_external_props_vars</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">enc_external_props_cts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">enc_ch_model</span><span class="o">.</span><span class="n">ssa</span><span class="o">.</span><span class="n">external_vars</span><span class="p">:</span>
            <span class="n">enc_external_props_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
            <span class="n">enc_external_props_cts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pt</span><span class="p">(</span><span class="n">ks_var2ct</span><span class="p">[</span><span class="n">v</span><span class="p">]))</span>

        <span class="n">enc_var2ct</span> <span class="o">=</span> <span class="n">myCharacteristic</span><span class="o">.</span><span class="n">_sample_var2ct</span><span class="p">(</span>
            <span class="n">cipher_ch_model</span><span class="o">.</span><span class="n">enc_ch_model</span><span class="p">,</span> <span class="n">new_seed</span><span class="p">,</span> <span class="n">enc_external_props_cts</span><span class="p">)</span>

        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">enc_external_props_vars</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ks_var2ct</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">enc_var2ct</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> \
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ks_var2ct</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">enc_var2ct</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">ks_var2ct</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">enc_var2ct</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">init_props</span> <span class="o">=</span> <span class="n">CipherCharacteristic</span><span class="o">.</span><span class="n">get_properties_for_initialization</span><span class="p">(</span>
            <span class="n">cipher_ch_model</span><span class="p">,</span> <span class="p">{</span><span class="o">**</span><span class="n">ks_var2ct</span><span class="p">,</span> <span class="o">**</span><span class="n">enc_var2ct</span><span class="p">})</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">init_props</span><span class="p">)</span> <span class="o">==</span> <span class="mi">6</span>
        <span class="n">ks_input_prop</span><span class="p">,</span> <span class="n">ks_output_prop</span><span class="p">,</span> <span class="n">ks_assign_outprop_list</span> <span class="o">=</span> <span class="n">init_props</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">enc_input_prop</span><span class="p">,</span> <span class="n">enc_output_prop</span><span class="p">,</span> <span class="n">enc_assign_outprop_list</span> <span class="o">=</span> <span class="n">init_props</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span>

        <span class="c1"># avoid *_props=*_props (super might not abstract)</span>
        <span class="n">cipher_ch</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">ks_input_prop</span><span class="p">,</span>
            <span class="n">ks_output_prop</span><span class="p">,</span>
            <span class="n">ks_assign_outprop_list</span><span class="p">,</span>
            <span class="n">enc_input_prop</span><span class="p">,</span>
            <span class="n">enc_output_prop</span><span class="p">,</span>
            <span class="n">enc_assign_outprop_list</span><span class="p">,</span>
            <span class="n">cipher_ch_model</span><span class="p">,</span>
            <span class="n">ks_empirical_ch_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ks_empirical_data_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">enc_empirical_ch_weight</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">enc_empirical_data_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">ks_is_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">enc_is_valid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">cipher_ch</span></div>

<div class="viewcode-block" id="CipherCharacteristic.get_formatted_logged_msgs"><a class="viewcode-back" href="../../../cascada.abstractproperty.characteristic.html#cascada.abstractproperty.characteristic.CipherCharacteristic.get_formatted_logged_msgs">[docs]</a>    <span class="k">def</span> <span class="nf">get_formatted_logged_msgs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the list of logged messages.</span>

<span class="sd">        See also `Characteristic.get_formatted_logged_msgs`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ks_characteristic</span><span class="o">.</span><span class="n">get_formatted_logged_msgs</span><span class="p">()</span> <span class="o">+</span> \
               <span class="bp">self</span><span class="o">.</span><span class="n">enc_characteristic</span><span class="o">.</span><span class="n">get_formatted_logged_msgs</span><span class="p">()</span></div></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Adrián Ranea.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>